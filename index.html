<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BON Cafe Team Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #10b981; --primary-dark: #059669;
      --bg: #f3f4f6; --surface: #ffffff; --sidebar-bg: #111827;
      --text: #1f2937; --text-light: #6b7280; --border: #e5e7eb; --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; display: flex; }
    
    /* SIDEBAR */
    .sidebar {
      width: 260px; background: var(--sidebar-bg); color: white;
      height: 100vh; position: fixed; left: 0; top: 0;
      transition: transform 0.3s ease; z-index: 500;
      display: flex; flex-direction: column;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar.closed { transform: translateX(-260px); }
    
    .logo-area { 
        padding: 25px 20px; font-weight: 700; font-size: 1.1rem; 
        border-bottom: 1px solid #374151; display: flex; align-items: center; 
        justify-content: space-between; cursor: pointer; letter-spacing: 0.5px; 
    }
    .nav-links { list-style: none; padding: 20px 10px; overflow-y: auto; flex: 1; }
    .nav-item {
      padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; cursor: pointer;
      display: flex; align-items: center; gap: 12px; color: #d1d5db; transition: all 0.2s;
    }
    .nav-item:hover { background: rgba(255,255,255,0.08); color: white; transform: translateX(3px); }
    .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .nav-item i { font-size: 20px; }

    /* MAIN CONTENT */
    .main-wrapper {
      flex: 1; margin-left: 260px; height: 100vh; display: flex; flex-direction: column;
      transition: margin-left 0.3s ease; width: 100%;
    }
    .main-wrapper.full { margin-left: 0; }

    /* TOP BAR */
    .top-bar {
      background: white; padding: 15px 30px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 20px; flex-shrink: 0;
      position: sticky; top: 0; z-index: 400;
    }
    .menu-btn { 
        cursor: pointer; color: var(--text); font-size: 28px; 
        padding: 5px; border-radius: 5px; transition: 0.2s; 
    }
    .menu-btn:hover { background: #f3f4f6; color: var(--primary); }
    
    /* CONTENT AREA */
    .content-area { flex: 1; padding: 20px; overflow-y: auto; overflow-x: hidden; position: relative; }
    .form-section { display: none; animation: slideUp 0.4s ease-out; max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); width: 100%; }
    .form-section.active { display: block; }
    
    /* WIDER FORM FOR REPORT */
    #report-dash { max-width: 1200px; }

    /* --- LANDING PAGE STYLES --- */
    .landing-wrapper { display: none; width: 100%; max-width: 1000px; margin: 0 auto; }
    .landing-wrapper.active { display: flex; flex-direction: column; gap: 20px; animation: slideUp 0.4s ease-out; }

    /* Carousel */
    .carousel-container { width: 100%; height: 260px; border-radius: var(--radius); overflow: hidden; position: relative; box-shadow: var(--shadow); }
    .slide { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; opacity: 0; transition: opacity 1s ease-in-out; transform: scale(1.05); }
    .slide.active-slide { opacity: 1; transform: scale(1); transition: opacity 1s, transform 6s; }

    /* Collapsible Role Section */
    .role-section { background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border); }
    .role-header { padding: 18px 25px; background: white; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
    .role-header:hover { background: #f9fafb; color: var(--primary); }
    .role-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; padding: 0 25px; background: #fff; }
    .role-content.open { max-height: 500px; padding: 20px 25px; border-top: 1px solid var(--border); }
    .role-content p { margin-bottom: 8px; line-height: 1.5; color: #4b5563; }

    /* Category Cards Grid */
    .category-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; }
    .cat-card { background: white; padding: 30px 15px; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; position: relative; overflow: hidden; }
    .cat-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .cat-card i { font-size: 36px; color: var(--primary); margin-bottom: 15px; display: block; transition: 0.3s; }
    .cat-card:hover i { transform: scale(1.1); }
    .cat-card span { font-weight: 600; color: var(--text); }

    /* Scorecard */
    .scorecard-container { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
    .score-box { flex: 1; min-width: 130px; background: #ffffff; border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .score-title { font-size: 0.8rem; color: #6b7280; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
    .score-val { font-size: 1.8rem; font-weight: 700; color: var(--text); }
    
    /* Common */
    h2 { margin-bottom: 20px; color: #111827; font-weight: 700; font-size: 1.5rem; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 0.9rem; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: 0.2s; background: #f9fafb; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; background: white; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
    .submit-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem; }
    .submit-btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
    
    /* 9-Day Grid */
    .training-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
    .day-card { border: 1px solid var(--border); padding: 25px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.2s; background: white; }
    .day-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: var(--shadow); background: #ecfdf5; }
    .day-num { font-size: 1.8rem; font-weight: 700; color: var(--primary); display: block; margin-bottom: 5px; }
    
    /* History/Report Table */
    .filter-bar { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; align-items: flex-end; }
    .filter-bar div { flex: 1; min-width: 140px; }
    .filter-bar input { margin-top: 0; background: white; }
    .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border); }
    .history-table { width: 100%; border-collapse: collapse; min-width: 600px; }
    .history-table th, .history-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
    .history-table th { background: #f3f4f6; font-weight: 600; white-space: nowrap; color: #374151; }
    .done-tag { background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; letter-spacing: 0.5px; white-space: nowrap; }
    
    /* Modals */
    .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
    .modal-box { background: white; padding: 35px; border-radius: 16px; width: 90%; max-width: 340px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); animation: scaleUp 0.3s; }
    .modal-box h3 { font-size: 1.4rem; color: #1f2937; margin-bottom: 10px; }
    .modal-box p { color: #6b7280; margin-bottom: 25px; line-height: 1.4; }
    .modal-btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; margin: 0 6px; font-weight: 600; transition: 0.2s; }
    .btn-yes { background: var(--primary); color: white; }
    .btn-yes:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-no { background: #f3f4f6; color: #4b5563; }
    .btn-no:hover { background: #e5e7eb; }

    #admin-pin-input { letter-spacing: 8px; font-size: 1.5rem; text-align: center; font-weight: 700; border: 2px solid #e5e7eb; border-radius: 10px; transition: 0.2s; width: 100%; max-width: 200px; }
    #admin-pin-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }

    /* TOAST NOTIFICATION */
    #notification { position: fixed; top: 25px; right: 25px; background: white; color: #1f2937; padding: 16px 24px; border-radius: 10px; display: none; z-index: 1100; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border-left: 5px solid var(--primary); font-weight: 500; align-items: center; gap: 10px; animation: slideInRight 0.4s; }
    #notification.error { border-left-color: #ef4444; }
    #notification.fade-out { animation: fadeOut 0.3s forwards; }
    #notification i { font-size: 20px; }
    
    .footer { background: white; border-top: 1px solid var(--border); padding: 20px; text-align: center; font-size: 0.85rem; color: var(--text-light); margin-top: auto; letter-spacing: 0.5px; }

    /* Conditional */
    .question-block { background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); }
    .q-options { display: flex; gap: 15px; margin-top: 12px; flex-wrap: wrap; }
    .hidden-input { display: none; margin-top: 12px; animation: fadeIn 0.3s; }
    .hidden-input.show { display: block; }
    
    @media print { .sidebar, .top-bar, .filter-bar, .submit-btn, .print-hide, .footer { display: none !important; } .main-wrapper { margin: 0; height: auto; } .content-area { padding: 0; overflow: visible; } #report-dash { box-shadow: none; max-width: 100%; padding: 0; } body { overflow: visible; background: white; } }
    
    /* MOBILE SPECIFIC */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-260px); }
      .sidebar.closed { transform: translateX(0); }
      .sidebar.mobile-open { transform: translateX(0); }
      .main-wrapper { margin-left: 0; width: 100%; }
      .content-area { padding: 10px; }
      .carousel-container { height: 180px; }
      .scorecard-container { flex-direction: column; }
      .top-bar { padding: 10px 15px; }
      .form-section { padding: 20px 15px; }
      .table-responsive { margin-left: -15px; margin-right: -15px; width: calc(100% + 30px); border-radius: 0; border-left: none; border-right: none; }
      #notification { top: 10px; right: 10px; left: 10px; justify-content: center; }
    }
    
    /* Animation Keyframes */
    @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
    @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="logo-area" onclick="showTab('landing')">
      TEAM LEADERS' PORTAL
      <!-- Mobile Close Button -->
      <i class="material-icons" onclick="toggleMenu()" style="cursor:pointer; display:none;" id="sidebar-close-btn">close</i>
    </div>
    <ul class="nav-links">
      <li class="nav-item" onclick="showTab('landing')"><i class="material-icons">home</i> Home</li>
      <li class="nav-item" onclick="showTab('daily')"><i class="material-icons">today</i> Daily Task</li>
      <li class="nav-item" onclick="showTab('weekly')"><i class="material-icons">event_note</i> Weekly Task</li>
      <li class="nav-item" onclick="showTab('problem')"><i class="material-icons">report_problem</i> Report Problem</li>
      <li class="nav-item" onclick="showTab('vacation')"><i class="material-icons">flight</i> Vacation</li>
      <li style="margin: 15px 0; border-top: 1px solid #374151;"></li>
      <li class="nav-item" onclick="confirmTraining()"><i class="material-icons">school</i> 9-Days Training</li>
      <li class="nav-item" onclick="showHistory()"><i class="material-icons">history</i> Training History</li>
      <li class="nav-item" onclick="checkAdminAccess()"><i class="material-icons">dashboard</i> Report Dashboard</li>
    </ul>
  </div>

  <div class="main-wrapper" id="main-wrapper">
    <!-- TOP BAR WITH SANDWICH ICON -->
    <div class="top-bar">
      <i class="material-icons menu-btn" onclick="toggleMenu()">menu</i>
      <h3 id="page-title">Home</h3>
    </div>

    <div class="content-area">
      <!-- LANDING -->
      <div id="landing" class="landing-wrapper active">
        <div class="carousel-container">
            <img src="https://images.unsplash.com/photo-1522071820081-009f0129c71c?auto=format&fit=crop&w=1000&q=80" class="slide active-slide">
            <img src="https://images.unsplash.com/photo-1557804506-669a67965ba0?auto=format&fit=crop&w=1000&q=80" class="slide">
            <img src="https://images.unsplash.com/photo-1600880292203-757bb62b4baf?auto=format&fit=crop&w=1000&q=80" class="slide">
        </div>
        <div class="role-section">
            <div class="role-header" onclick="toggleRoles()"><span>Role and Duties of Team Leaders</span><i class="material-icons" id="role-icon">expand_more</i></div>
            <div class="role-content" id="role-text">
                <p><strong>1. Team Management:</strong> Oversee daily operations, ensure attendance, and manage shift schedules.</p>
                <p><strong>2. Reporting:</strong> Submit daily and weekly task reports promptly to the Area Manager.</p>
                <p><strong>3. Training:</strong> Conduct the 9-Day training program for new hires and log progress.</p>
                <p><strong>4. Problem Solving:</strong> Address technical or HR issues immediately and escalate if necessary.</p>
                <p><strong>5. Performance:</strong> Monitor team KPIs and ensure quality standards are met.</p>
            </div>
        </div>
        <div class="category-grid">
            <div class="cat-card" onclick="showTab('daily')"><i class="material-icons">today</i><span>Daily Task</span></div>
            <div class="cat-card" onclick="showTab('weekly')"><i class="material-icons">event_note</i><span>Weekly Task</span></div>
            <div class="cat-card" onclick="showTab('problem')"><i class="material-icons">report_problem</i><span>Report Problem</span></div>
            <div class="cat-card" onclick="showTab('vacation')"><i class="material-icons">flight</i><span>Vacation</span></div>
            <div class="cat-card" onclick="confirmTraining()"><i class="material-icons">school</i><span>Training</span></div>
            <div class="cat-card" onclick="showHistory()"><i class="material-icons">history</i><span>History</span></div>
            <div class="cat-card" onclick="checkAdminAccess()"><i class="material-icons">dashboard</i><span>Report Dash</span></div>
        </div>
      </div>

      <!-- FORMS -->
      <div id="daily" class="form-section">
        <h2>Daily Task Checklist</h2>
        <form onsubmit="handleDynamicSubmit(event, 'Daily Task')">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
             <div class="form-group"><label>Name</label><input list="dl-names" name="name" required placeholder="Select Name..."></div>
             <div class="form-group"><label>ID</label><input list="dl-ids" name="empId" required placeholder="Select ID..."></div>
          </div>
          <div class="form-group"><label>Branch</label><input list="dl-branches" name="branch" required placeholder="Select Branch..."></div>
          <div class="form-group"><label>Supervisor</label><input list="dl-sups" name="supervisor" required placeholder="Select Supervisor..."></div>
          <div class="form-group"><label>Area Manager</label><input list="dl-ams" name="areaManager" required placeholder="Select Area Manager..."></div>
          <div id="daily-questions">Loading...</div>
          <button class="submit-btn">Submit Daily Task</button>
        </form>
      </div>

      <div id="weekly" class="form-section">
        <h2>Weekly Task Report</h2>
        <form onsubmit="handleDynamicSubmit(event, 'Weekly Task')">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
             <div class="form-group"><label>Name</label><input list="dl-names" name="name" required placeholder="Select Name..."></div>
             <div class="form-group"><label>ID</label><input list="dl-ids" name="empId" required placeholder="Select ID..."></div>
          </div>
          <div class="form-group"><label>Branch</label><input list="dl-branches" name="branch" required placeholder="Select Branch..."></div>
          <div class="form-group"><label>Supervisor</label><input list="dl-sups" name="supervisor" required placeholder="Select Supervisor..."></div>
          <div class="form-group"><label>Area Manager</label><input list="dl-ams" name="areaManager" required placeholder="Select Area Manager..."></div>
          <div class="form-group"><label>Week Ending</label><input type="date" name="weekDate" required></div>
          <div id="weekly-questions">Loading...</div>
          <button class="submit-btn">Submit Weekly Report</button>
        </form>
      </div>

      <div id="problem" class="form-section">
        <h2>Report Problem</h2>
        <form onsubmit="handleSubmit(event, 'Report Problem')">
          <div class="form-group"><label>Name</label><input list="dl-names" name="name" required placeholder="Select Name..."></div>
          <div class="form-group"><label>Type</label><select name="issueType"><option>Technical</option><option>HR</option></select></div>
          <div class="form-group"><label>Description</label><textarea name="description" rows="3" required></textarea></div>
          <div class="form-group"><label>Urgency</label><select name="urgency"><option>Low</option><option>High</option></select></div>
          <button class="submit-btn">Submit</button>
        </form>
      </div>

      <div id="vacation" class="form-section">
        <h2>Vacation Detail</h2>
        <form onsubmit="handleSubmit(event, 'Vacation')">
          <div class="form-group"><label>Name</label><input list="dl-names" name="name" required placeholder="Select Name..."></div>
          <div class="form-group" style="display:flex; gap:10px;">
            <div style="flex:1"><label>Start</label><input type="date" name="startDate" required></div>
            <div style="flex:1"><label>End</label><input type="date" name="endDate" required></div>
          </div>
          <div class="form-group"><label>Reason</label><input type="text" name="reason" required></div>
          <button class="submit-btn">Submit</button>
        </form>
      </div>

      <div id="training-dash" class="form-section">
        <h2>9-Days Training</h2>
        <div class="training-grid">
          <div class="day-card" onclick="loadTrainingDay(1)"><span class="day-num">1</span> Day One</div>
          <div class="day-card" onclick="loadTrainingDay(2)"><span class="day-num">2</span> Day Two</div>
          <div class="day-card" onclick="loadTrainingDay(3)"><span class="day-num">3</span> Day Three</div>
          <div class="day-card" onclick="loadTrainingDay(4)"><span class="day-num">4</span> Day Four</div>
          <div class="day-card" onclick="loadTrainingDay(5)"><span class="day-num">5</span> Day Five</div>
          <div class="day-card" onclick="loadTrainingDay(6)"><span class="day-num">6</span> Day Six</div>
          <div class="day-card" onclick="loadTrainingDay(7)"><span class="day-num">7</span> Day Seven</div>
          <div class="day-card" onclick="loadTrainingDay(8)"><span class="day-num">8</span> Day Eight</div>
          <div class="day-card" onclick="loadTrainingDay(9)"><span class="day-num">9</span> Day Nine</div>
        </div>
      </div>

      <div id="training-dynamic" class="form-section">
        <div onclick="showTab('training-dash')" style="cursor:pointer; margin-bottom:15px; color:#6b7280; font-weight:500;">&#8592; Back to Grid</div>
        <h2 id="training-title">Training Day</h2>
        <form id="dynamic-form" onsubmit="handleDynamicSubmit(event, 'Training')">
          <input type="hidden" name="category" id="train-cat">
          <div class="form-group"><label>Trainee Name</label><input type="text" name="traineeName" required placeholder="Enter Trainee Name (Manual)"></div>
          <div class="form-group"><label>Trainee ID</label><input type="text" name="traineeId" required placeholder="Enter Trainee ID (Manual)"></div>
          <div class="form-group"><label>Trainer Name</label><input list="dl-names" name="trainerName" required placeholder="Select Trainer..."></div>
          <div id="questions-container">Loading...</div>
          <div class="form-group"><label>Notes</label><textarea name="notes" rows="3"></textarea></div>
          <button class="submit-btn">Submit Evaluation</button>
        </form>
      </div>

      <div id="history-view" class="form-section" style="max-width:1000px;">
        <h2>Training History</h2>
        <div class="filter-bar">
          <input list="dl-ids" id="hist-id" placeholder="Filter by Employee ID">
          <input type="date" id="hist-start" placeholder="Start Date">
          <input type="date" id="hist-end" placeholder="End Date">
          <button class="submit-btn" style="width:auto;" onclick="fetchHistory()">Filter</button>
        </div>
        <div class="table-responsive">
            <table class="history-table">
              <thead><tr><th>Date</th><th>Day</th><th>Name</th><th>ID</th><th>Trainer</th><th>Notes</th></tr></thead>
              <tbody id="history-body"><tr><td colspan="6" style="text-align:center;">Click Filter to load data</td></tr></tbody>
            </table>
        </div>
      </div>

      <div id="report-dash" class="form-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
           <h2>Report Dashboard</h2>
           <button class="submit-btn print-hide" style="width:auto; background:#374151;" onclick="window.print()">Print Report</button>
        </div>
        <div class="filter-bar print-hide">
           <div><label>Name/ID</label><input list="dl-names" id="rd-name" placeholder="Search..."></div>
           <div><label>Branch</label><input list="dl-branches" id="rd-branch" placeholder="Search..."></div>
           <div><label>Supervisor</label><input list="dl-sups" id="rd-sup" placeholder="Search..."></div>
           <div><label>Area Manager</label><input list="dl-ams" id="rd-am" placeholder="Search..."></div>
           <div><label>Start</label><input type="date" id="rd-start"></div>
           <div><label>End</label><input type="date" id="rd-end"></div>
           <button class="submit-btn" style="height:42px; width:auto;" onclick="loadReportData()">Load Data</button>
        </div>
        <div class="scorecard-container">
           <div class="score-box"><div class="score-title">Daily Progress</div><div class="score-val" id="sc-daily">-</div></div>
           <div class="score-box"><div class="score-title">Weekly Progress</div><div class="score-val" id="sc-weekly">-</div></div>
           <div class="score-box"><div class="score-title">Training Bonus</div><div class="score-val" id="sc-train">-</div></div>
           <div class="score-box" style="background:#f0f9ff; border-color:#bae6fd;"><div class="score-title" style="color:#0369a1;">Overall Score</div><div class="score-val" style="color:#0284c7;" id="sc-total">-</div></div>
        </div>
        <h3>Daily Task Reports</h3>
        <div class="table-responsive">
            <table class="history-table">
              <thead><tr><th>Date</th><th>Name</th><th>ID</th><th>Branch</th><th>Supervisor</th><th>Area Manager</th><th>Cleanliness Status</th></tr></thead>
              <tbody id="rd-daily-body"><tr><td colspan="7" style="text-align:center;">Click Load Data</td></tr></tbody>
            </table>
        </div>
        <h3 style="margin-top:30px;">Weekly Task Reports</h3>
        <div class="table-responsive">
            <table class="history-table">
              <thead><tr id="rd-weekly-header"><th>Date</th><th>Name</th><th>ID</th><th>Branch</th><th>Supervisor</th><th>AM</th><th>W. Ending</th><th>Done?</th></tr></thead>
              <tbody id="rd-weekly-body"><tr><td colspan="8" style="text-align:center;">Click Load Data</td></tr></tbody>
            </table>
        </div>
      </div>
    </div>
    <div class="footer">Created by the Training-Coordinator | BON Cafe.</div>
  </div>

  <datalist id="dl-names"></datalist><datalist id="dl-ids"></datalist><datalist id="dl-branches"></datalist><datalist id="dl-sups"></datalist><datalist id="dl-ams"></datalist>

  <!-- WELCOME MODAL (New) -->
  <div id="welcome-modal" class="modal-overlay">
    <div class="modal-box">
      <i class="material-icons" style="font-size:48px; color:var(--primary); margin-bottom:10px;">waving_hand</i>
      <h3>Welcome Back!</h3>
      <p>Team Leader</p>
      <button class="modal-btn btn-yes" onclick="closeWelcome()" style="width:100px;">OK</button>
    </div>
  </div>

  <div id="confirm-modal" class="modal-overlay"><div class="modal-box"><i class="material-icons" style="font-size:48px; color:var(--primary); margin-bottom:10px;">school</i><h3>Start Training?</h3><p>You are about to access the 9-Day training program. Proceed?</p><div><button class="modal-btn btn-no" onclick="closeModal()">Cancel</button><button class="modal-btn btn-yes" onclick="proceedToTraining()">Yes, Start</button></div></div></div>
  <div id="pin-modal" class="modal-overlay"><div class="modal-box"><i class="material-icons" style="font-size:48px; color:#4b5563; margin-bottom:10px;">lock</i><h3>Admin Access</h3><p>Enter the secure PIN code to view the Report Dashboard.</p><input type="password" id="admin-pin-input" placeholder="••••"><p id="pin-error" style="color:#ef4444; font-size:0.85rem; margin-top:10px; display:none;"><i class="material-icons" style="font-size:14px; vertical-align:middle;">error</i> Incorrect PIN</p><div style="margin-top:25px;"><button class="modal-btn btn-no" onclick="closePinModal()">Cancel</button><button class="modal-btn btn-yes" onclick="verifyPin()">Unlock</button></div></div></div>
  
  <!-- NOTIFICATION (Hidden by default via style) -->
  <div id="notification" style="display:none;"><i class="material-icons">check_circle</i><span id="notif-text">Success!</span></div>

  <script>
    // *** IMPORTANT: PASTE YOUR APP SCRIPT DEPLOYMENT URL HERE ***
    const API_URL = "https://script.google.com/macros/s/AKfycbyRtDjSzUxjygsRpcKe20a0m_ytOazLh5_SWuwIfGy456UmGjtFo_4pJqk7e0M41jkKpA/exec"; 

    // HELPERS TO REPLACE google.script.run
    async function fetchAPI(action, params = {}) {
      const url = new URL(API_URL);
      url.searchParams.append('action', action);
      for(const key in params) { url.searchParams.append(key, params[key]); }
      try {
        const response = await fetch(url.toString());
        return await response.json();
      } catch (e) {
        showToast("Connection Error", false);
        return null;
      }
    }

    async function postAPI(data) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: { "Content-Type": "text/plain;charset=utf-8" }
        });
        return await response.json();
      } catch (e) {
        return { success: false, message: e.toString() };
      }
    }

    // --- SIDEBAR TOGGLE LOGIC ---
    function toggleMenu() {
      const sb = document.getElementById('sidebar');
      const main = document.getElementById('main-wrapper');
      const closeBtn = document.getElementById('sidebar-close-btn');
      
      if(window.innerWidth <= 768) {
        sb.classList.toggle('mobile-open');
        // Show/Hide Close button inside sidebar on mobile
        closeBtn.style.display = sb.classList.contains('mobile-open') ? 'block' : 'none';
      } else {
        sb.classList.toggle('closed');
        main.classList.toggle('full');
      }
    }

    // --- CAROUSEL ---
    let slideIndex = 0;
    function showSlides() {
      let slides = document.getElementsByClassName("slide");
      if(!slides.length) return;
      for (let i = 0; i < slides.length; i++) {
        slides[i].classList.remove("active-slide");
      }
      slideIndex++;
      if (slideIndex > slides.length) {slideIndex = 1}
      slides[slideIndex-1].classList.add("active-slide");
      setTimeout(showSlides, 4000);
    }
    showSlides();

    // --- COLLAPSIBLE ---
    function toggleRoles() {
        const content = document.getElementById('role-text');
        const icon = document.getElementById('role-icon');
        content.classList.toggle('open');
        icon.innerText = content.classList.contains('open') ? "expand_less" : "expand_more";
    }

    // --- NAV ---
    function showTab(id, updateHistory = true) {
      if(window.innerWidth <= 768) {
          const sb = document.getElementById('sidebar');
          sb.classList.remove('mobile-open');
      }
      
      document.querySelectorAll('.form-section').forEach(e => e.classList.remove('active'));
      document.getElementById('landing').classList.remove('active');
      document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));

      if(id === 'landing') {
          document.getElementById('landing').classList.add('active');
          document.getElementById('page-title').innerText = "Home";
      } else {
          document.getElementById(id).classList.add('active');
          let title = id.charAt(0).toUpperCase() + id.slice(1);
          if(id === 'problem') title = "Report Problem";
          if(id === 'training-dash') title = "Training Dashboard";
          if(id === 'report-dash') title = "Report Dashboard";
          document.getElementById('page-title').innerText = title;
      }
      if (updateHistory) window.history.pushState({pageId: id}, "", "#" + id);
    }

    window.onpopstate = function(event) {
        if (event.state && event.state.pageId) {
            if(event.state.pageId === 'report-dash' && !isAdminUnlocked) {
                showTab('landing', false);
            } else {
                showTab(event.state.pageId, false);
            }
        } else {
            showTab('landing', false);
        }
    };

    // --- MODALS ---
    function confirmTraining() {
      if(window.innerWidth <= 768) { document.getElementById('sidebar').classList.remove('mobile-open'); }
      document.getElementById('confirm-modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }
    function proceedToTraining() { closeModal(); showTab('training-dash'); }

    // --- WELCOME MODAL ---
    function closeWelcome() {
       document.getElementById('welcome-modal').style.display = 'none';
    }

    // --- ADMIN PIN ---
    let isAdminUnlocked = false;
    function checkAdminAccess() {
        if(window.innerWidth <= 768) { document.getElementById('sidebar').classList.remove('mobile-open'); }
        if (isAdminUnlocked) {
            showReportDash();
        } else {
            document.getElementById('admin-pin-input').value = '';
            document.getElementById('pin-error').style.display = 'none';
            document.getElementById('pin-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('admin-pin-input').focus(), 100);
        }
    }
    function closePinModal() { document.getElementById('pin-modal').style.display = 'none'; }
    async function verifyPin() {
        const pin = document.getElementById('admin-pin-input').value;
        const btn = document.querySelector('#pin-modal .btn-yes');
        const originalText = btn.innerText;
        btn.innerText = "Checking..."; btn.disabled = true;

        const isValid = await fetchAPI('verifyAdminPin', {pin: pin});
        
        btn.innerText = originalText; btn.disabled = false;
        if(isValid) {
            isAdminUnlocked = true;
            closePinModal();
            showReportDash();
            showToast("Access Granted", true);
        } else {
            document.getElementById('pin-error').style.display = 'block';
        }
    }

    // --- TOAST ---
    function showToast(message, isSuccess = true) {
        const toast = document.getElementById('notification');
        const icon = toast.querySelector('i');
        const text = document.getElementById('notif-text');
        
        toast.classList.remove('error', 'fade-out');
        text.innerText = message;
        if(isSuccess) {
            icon.innerText = 'check_circle'; icon.style.color = 'var(--primary)';
        } else {
            toast.classList.add('error'); icon.innerText = 'error'; icon.style.color = '#ef4444';
        }
        
        // Remove inline display none if present, use flex
        toast.style.removeProperty('display');
        toast.style.display = 'flex';
        
        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => { toast.style.display = 'none'; toast.classList.remove('fade-out'); }, 300);
        }, 3000);
    }

    // --- REPORT DASH ---
    function showReportDash() {
      showTab('report-dash');
      const date = new Date();
      document.getElementById('rd-start').valueAsDate = new Date(date.getFullYear(), date.getMonth(), 1);
      document.getElementById('rd-end').valueAsDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    }

    async function loadReportData() {
      const filters = {
        name: document.getElementById('rd-name').value,
        branch: document.getElementById('rd-branch').value,
        sup: document.getElementById('rd-sup').value,
        am: document.getElementById('rd-am').value,
        start: document.getElementById('rd-start').value,
        end: document.getElementById('rd-end').value
      };

      document.getElementById('rd-daily-body').innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Loading...</td></tr>';
      document.getElementById('rd-weekly-body').innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">Loading...</td></tr>';

      const data = await fetchAPI('getDashboardData', filters);
      if(data) {
         renderReportTables(data);
         calculateScorecard(data);
      }
    }

    function renderReportTables(data) {
       const dBody = document.getElementById('rd-daily-body');
       if(data.daily.length === 0) {
         dBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No records found.</td></tr>';
       } else {
         let html = '';
         data.daily.forEach(r => {
           let statusCell = r.status === "Done" ? '<span class="done-tag">Done</span>' : `<span style="color:#ef4444; font-weight:600;">${r.status}</span>`;
           html += `<tr><td>${r.date}</td><td>${r.name}</td><td>${r.id}</td><td>${r.branch}</td><td>${r.sup}</td><td>${r.am}</td><td>${statusCell}</td></tr>`;
         });
         dBody.innerHTML = html;
       }

       const wBody = document.getElementById('rd-weekly-body');
       const wHead = document.getElementById('rd-weekly-header');
       let headHtml = '<th>Date</th><th>Name</th><th>ID</th><th>Branch</th><th>Supervisor</th><th>AM</th><th>W. Ending</th>';
       data.weeklyHeaders.forEach((h, i) => headHtml += `<th>Q${i+1}</th>`);
       headHtml += '<th>Status</th>';
       wHead.innerHTML = headHtml;

       if(data.weekly.length === 0) {
         wBody.innerHTML = `<tr><td colspan="${8 + data.weeklyHeaders.length}" style="text-align:center; padding:20px;">No records found.</td></tr>`;
       } else {
         let html = '';
         data.weekly.forEach(r => {
            let answersHtml = '';
            r.answers.forEach(a => answersHtml += `<td>${a}</td>`);
            html += `<tr><td>${r.date}</td><td>${r.name}</td><td>${r.id}</td><td>${r.branch}</td><td>${r.sup}</td><td>${r.am}</td><td>${r.weekEnd}</td>${answersHtml}<td><span class="done-tag">Done</span></td></tr>`;
         });
         wBody.innerHTML = html;
       }
    }

    function calculateScorecard(data) {
       if(data.daily.length === 0 && data.weekly.length === 0) {
           document.getElementById('sc-daily').innerText = "-";
           document.getElementById('sc-weekly').innerText = "-";
           document.getElementById('sc-train').innerText = "-";
           document.getElementById('sc-total').innerText = "-";
           return;
       }
       let dailyProgress = Math.min((data.daily.length / 26), 1); 
       let weeklyProgress = Math.min((data.weekly.length / 4), 1); 
       let trainScore = 0, dailyWeight = 0.5, weeklyWeight = 0.5; 

       document.getElementById('sc-daily').innerText = Math.round(dailyProgress * 100) + "%";
       document.getElementById('sc-weekly').innerText = Math.round(weeklyProgress * 100) + "%";

       if(data.hasTraining) {
         document.getElementById('sc-train').innerText = "20%";
         trainScore = 0.2; dailyWeight = 0.4; weeklyWeight = 0.4;
       } else {
         document.getElementById('sc-train').innerText = "N/A";
         dailyWeight = 0.5; weeklyWeight = 0.5;
       }
       document.getElementById('sc-total').innerText = Math.round(((dailyProgress * dailyWeight) + (weeklyProgress * weeklyWeight) + trainScore) * 100) + "%";
    }

    // --- HISTORY ---
    function showHistory() { showTab('history-view'); fetchHistory(); }
    async function fetchHistory() {
      const id = document.getElementById('hist-id').value;
      const start = document.getElementById('hist-start').value;
      const end = document.getElementById('hist-end').value;
      const tbody = document.getElementById('history-body');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>';
      
      const data = await fetchAPI('getTrainingHistory', {id, start, end});
      if(data) {
          if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No records found.</td></tr>';
          } else {
            let html = '';
            data.forEach(row => {
              html += `<tr><td>${row.date}</td><td><span style="background:#e0e7ff; color:#3730a3; padding:2px 8px; border-radius:4px; font-size:0.8em;">${row.day}</span></td><td>${row.name}</td><td>${row.id}</td><td>${row.trainer}</td><td>${row.notes}</td></tr>`;
            });
            tbody.innerHTML = html;
          }
      }
    }

    // --- INIT ---
    window.onload = function() {
      window.history.replaceState({pageId: 'landing'}, "", "#landing");
      
      // SHOW WELCOME MODAL ON LOAD
      document.getElementById('welcome-modal').style.display = 'flex';
      
      loadDaily();
      loadWeekly();
      loadGlobalDropdowns();
    };

    async function loadDaily() {
      const qs = await fetchAPI('getQuestions', {sheetName: 'Daily Config'});
      if(qs) renderChecklist(qs, 'daily-questions', 'daily');
    }
    async function loadWeekly() {
      const qs = await fetchAPI('getQuestions', {sheetName: 'Weekly Config'});
      if(qs) renderChecklist(qs, 'weekly-questions', 'weekly');
    }
    
    async function loadGlobalDropdowns() {
       const res = await fetchAPI('getGlobalDropdowns');
       if(res) {
          populateDatalist('dl-names', res.names);
          populateDatalist('dl-ids', res.ids);
          populateDatalist('dl-branches', res.branches);
          populateDatalist('dl-sups', res.sups);
          populateDatalist('dl-ams', res.ams);
       }
    }
    
    function populateDatalist(id, list) {
       const dl = document.getElementById(id);
       dl.innerHTML = '';
       list.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item;
          dl.appendChild(opt);
       });
    }

    function renderChecklist(qs, containerId, type) {
      const div = document.getElementById(containerId);
      if(!qs.length) { div.innerHTML = 'No questions configured.'; return; }
      let html = '';
      qs.forEach((q, i) => {
        if(type === 'weekly' && i > 0) {
           html += `<div class="question-block"><div>${i+1}. ${q}</div><textarea name="weekly_q_${i}" rows="2"></textarea></div>`;
        } else {
           let prefix = type === 'daily' ? 'daily' : 'weekly';
           html += `<div class="question-block">
             <div>${i+1}. ${q}</div>
             <div class="q-options">
               <label style="display:inline-flex; gap:5px;"><input type="radio" name="${prefix}_q_${i}" value="Yes" onchange="toggleReason('${prefix}',${i},this.value)"> Yes</label>
               <label style="display:inline-flex; gap:5px;"><input type="radio" name="${prefix}_q_${i}" value="No" onchange="toggleReason('${prefix}',${i},this.value)"> No</label>
               ${type === 'daily' ? `<label style="display:inline-flex; gap:5px;"><input type="radio" name="${prefix}_q_${i}" value="N/A" onchange="toggleReason('${prefix}',${i},this.value)"> N/A</label>` : ''}
             </div>
             <div id="${prefix}_hidden_${i}" class="hidden-input"><input type="text" name="${prefix}_${type === 'daily' ? 'reason' : 'detail'}_${i}" placeholder="Details..."></div>
           </div>`;
        }
      });
      div.innerHTML = html;
    }

    function toggleReason(prefix, idx, val) {
      const el = document.getElementById(`${prefix}_hidden_${idx}`);
      const show = (prefix === 'daily' && val === 'No') || (prefix === 'weekly' && val === 'Yes');
      el.style.display = show ? 'block' : 'none';
      const input = el.querySelector('input');
      if(input) input.required = show;
    }

    // --- TRAINING ---
    async function loadTrainingDay(day) {
      showTab('training-dynamic');
      document.getElementById('training-title').innerText = "Training Day " + day;
      document.getElementById('train-cat').value = "Training Day " + day;
      const div = document.getElementById('questions-container');
      div.innerHTML = 'Loading...';
      
      const qs = await fetchAPI('getTrainingQuestions', {day: day});
      if(qs) {
        if(!qs.length) { div.innerHTML = 'No questions.'; return; }
        let html = '';
        qs.forEach((q, i) => {
          html += `<div class="question-block"><div>${i+1}. ${q}</div><div class="q-options"><label style="margin-right:10px;"><input type="radio" name="q_${i}" value="Pass" required> Pass</label><label style="margin-right:10px;"><input type="radio" name="q_${i}" value="Fail"> Fail</label><label><input type="radio" name="q_${i}" value="Retrain"> Retrain</label></div></div>`;
        });
        div.innerHTML = html;
      }
    }

    // --- SUBMIT ---
    async function handleDynamicSubmit(e, cat) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const obj = { category: cat };
      fd.forEach((v, k) => obj[k] = v);
      sendData(e.target, obj);
    }
    async function handleSubmit(e, cat) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const obj = { category: cat };
      fd.forEach((v, k) => obj[k] = v);
      sendData(e.target, obj);
    }

    async function sendData(form, obj) {
      const btn = form.querySelector('button');
      const txt = btn.innerText;
      btn.innerText = 'Saving...'; btn.disabled = true;
      
      const res = await postAPI(obj);
      
      btn.innerText = txt; btn.disabled = false;
      showToast(res.message, res.success);
      if(res.success) {
         form.reset();
         if(obj.category.includes('Training')) showTab('training-dash');
         if(obj.category === 'Daily Task') loadDaily();
         if(obj.category === 'Weekly Task') loadWeekly();
      }
    }
  </script>
</body>
</html>
