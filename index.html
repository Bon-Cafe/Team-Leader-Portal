<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BON Cafe Portal</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { margin: 0; font-family: sans-serif; background: #f3f4f6; color: #1f2937; height: 100vh; display: flex; flex-direction: column; }
    
    /* LOGIN SCREEN */
    #login-screen { position: fixed; inset: 0; background: #111827; z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .login-box { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 350px; text-align: center; }
    .input-field { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    .btn { width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn:disabled { background: #ccc; }

    /* MAIN APP */
    #app-container { display: none; flex: 1; height: 100%; }
    .sidebar { width: 250px; background: #111827; color: white; display: flex; flex-direction: column; padding: 20px; }
    .main-content { flex: 1; padding: 20px; overflow-y: auto; }
    
    .nav-item { padding: 15px; cursor: pointer; color: #d1d5db; display: flex; gap: 10px; align-items: center; }
    .nav-item:hover, .nav-item.active { color: #10b981; background: rgba(255,255,255,0.05); }
    
    .form-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none; }
    .form-card.active { display: block; }

    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: 500; margin-bottom: 5px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }

    /* LOADING SPINNER */
    #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 8000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    @media (max-width: 768px) {
      #app-container { flex-direction: column; }
      .sidebar { width: 100%; height: auto; padding: 10px; }
      .nav-item { padding: 10px; display: inline-flex; }
    }
  </style>
</head>
<body>

  <!-- LOADER -->
  <div id="loader"><div class="spinner"></div><p>Processing...</p></div>

  <!-- LOGIN -->
  <div id="login-screen">
    <div class="login-box">
      <h2>Team Leader Portal</h2>
      <input id="u" class="input-field" placeholder="Username">
      <input id="p" type="password" class="input-field" placeholder="Password">
      <button class="btn" onclick="doLogin()">Login</button>
      <div style="margin-top:15px; font-size:12px; cursor:pointer; color:grey;" onclick="toggleAdmin()">or Admin Login</div>
    </div>
  </div>

  <!-- APP -->
  <div id="app-container">
    <div class="sidebar">
       <h3>BON PORTAL</h3>
       <div class="nav-item active" onclick="show('dash')"><i class="material-icons">dashboard</i> Dashboard</div>
       <div class="nav-item" onclick="show('daily')"><i class="material-icons">today</i> Daily Task</div>
       <div class="nav-item" onclick="show('weekly')"><i class="material-icons">event_note</i> Weekly Task</div>
       <div class="nav-item" onclick="show('problem')"><i class="material-icons">report_problem</i> Report Problem</div>
       <div class="nav-item" onclick="show('vacation')"><i class="material-icons">flight</i> Vacation</div>
       <div class="nav-item" onclick="show('training')"><i class="material-icons">school</i> Training</div>
       <div style="margin-top:auto; font-size:12px; color:grey;">
          Logged in as: <span id="user-display"></span><br>
          <a href="#" onclick="logout()" style="color:white;">Logout</a>
       </div>
    </div>

    <div class="main-content">
       
       <!-- DASHBOARD -->
       <div id="dash" class="form-card active">
          <h2>Welcome, <span id="dash-name">User</span></h2>
          <div style="display:flex; gap:20px; margin:20px 0;">
             <div style="flex:1; background:#ecfdf5; padding:20px; border-radius:8px; text-align:center;">
                <h3>Profile</h3>
                <img id="dash-img" src="" style="width:80px; height:80px; border-radius:50%; background:#ccc;">
                <p id="dash-id">ID: </p>
             </div>
             <div style="flex:2; background:white; border:1px solid #eee; padding:20px; border-radius:8px;">
                <h3>Recent Reports</h3>
                <button class="btn" style="width:auto; padding:5px 10px;" onclick="loadDashData()">Refresh Data</button>
                <div id="dash-list" style="margin-top:10px;">Click refresh to load...</div>
             </div>
          </div>
       </div>

       <!-- DAILY FORM -->
       <div id="daily" class="form-card">
          <h2>Daily Task</h2>
          <form onsubmit="submitForm(event, 'Daily Task')">
             <div class="form-group"><label>Branch</label><select id="d-br" name="branch"></select></div>
             <div class="form-group"><label>Supervisor</label><select id="d-sup" name="supervisor"></select></div>
             <div class="form-group"><label>Area Manager</label><select id="d-am" name="areaManager"></select></div>
             <div id="daily-qs">Loading Questions...</div>
             <button class="btn">Submit</button>
          </form>
       </div>

       <!-- WEEKLY FORM -->
       <div id="weekly" class="form-card">
          <h2>Weekly Task</h2>
          <form onsubmit="submitForm(event, 'Weekly Task')">
             <div class="form-group"><label>Week Ending</label><input type="date" name="weekDate" required></div>
             <div class="form-group"><label>Branch</label><select id="w-br" name="branch"></select></div>
             <div id="weekly-qs">Loading Questions...</div>
             <button class="btn">Submit</button>
          </form>
       </div>

       <!-- PROBLEM FORM -->
       <div id="problem" class="form-card">
          <h2>Report Problem</h2>
          <form onsubmit="submitProblem(event)">
             <div class="form-group"><label>Supervisor</label><select id="p-sup" name="supervisor"></select></div>
             <div class="form-group"><label>Branch</label><select id="p-br" name="branch"></select></div>
             <div class="form-group"><label>Area Manager</label><select id="p-am" name="areaManager"></select></div>
             
             <div class="form-group">
                <label>Issue Type</label>
                <select name="issueType" onchange="checkUrg(this)">
                   <option>Maintenance</option><option>Team Member</option>
                   <option>Customer Complaint</option><option>Others</option>
                </select>
             </div>
             <div class="form-group" id="other-div" style="display:none;"><input name="issueTypeOther" placeholder="Specify..."></div>
             
             <div class="form-group"><label>Urgency</label><input id="urg" name="urgency" value="High Priority" readonly style="background:#eee;"></div>
             <div class="form-group"><label>Description</label><textarea name="description" required></textarea></div>
             
             <div class="form-group" style="border:1px dashed #ccc; padding:10px;">
                <label>Upload Image (Drive)</label>
                <input type="file" id="p-file" accept="image/*">
             </div>
             
             <button class="btn">Submit Report</button>
          </form>
       </div>

       <!-- VACATION -->
       <div id="vacation" class="form-card">
          <h2>Vacation</h2>
          <form onsubmit="submitForm(event, 'Vacation')">
             <label>Start Date</label><input type="date" name="startDate" required>
             <label>End Date</label><input type="date" name="endDate" required>
             <label>Reason</label><input name="reason" required>
             <button class="btn" style="margin-top:10px;">Submit</button>
          </form>
       </div>

       <!-- TRAINING -->
       <div id="training" class="form-card">
          <h2>Training</h2>
          <div style="margin-bottom:15px;">
             Select Day: 
             <select id="t-day" onchange="loadTrainQs(this.value)">
                <option value="">Select...</option>
                <option value="1">Day 1</option><option value="2">Day 2</option><option value="3">Day 3</option>
                <option value="4">Day 4</option><option value="5">Day 5</option><option value="6">Day 6</option>
                <option value="7">Day 7</option><option value="8">Day 8</option><option value="9">Day 9</option>
             </select>
          </div>
          <form id="t-form" onsubmit="submitForm(event, 'Training')" style="display:none;">
             <input type="hidden" name="day" id="t-day-val">
             <div class="form-group"><label>Trainee Name</label><input name="traineeName" required></div>
             <div class="form-group"><label>Trainee ID</label><input name="traineeId" required></div>
             <div class="form-group"><label>Trainer Name</label><select id="t-trainer" name="trainerName"></select></div>
             <div id="t-qs-area"></div>
             <div class="form-group"><label>Notes</label><textarea name="notes"></textarea></div>
             <button class="btn">Submit</button>
          </form>
       </div>

    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyRtDjSzUxjygsRpcKe20a0m_ytOazLh5_SWuwIfGy456UmGjtFo_4pJqk7e0M41jkKpA/exec"; // PASTE URL HERE

    let currentUser = null;
    let isAdminLogin = false;

    function toggleAdmin() {
       isAdminLogin = !isAdminLogin;
       alert(isAdminLogin ? "Admin Mode Active" : "User Mode Active");
    }

    async function doLogin() {
       const u = document.getElementById('u').value;
       const p = document.getElementById('p').value;
       if(!u || !p) return alert("Please enter credentials");

       load(true);
       try {
          const res = await fetchAPI('login', {username:u, password:p});
          if(res.success) {
             currentUser = res;
             initApp();
          } else {
             alert(res.message);
          }
       } catch(e) {
          alert("Login Failed: " + e);
       }
       load(false);
    }

    async function initApp() {
       document.getElementById('login-screen').style.display = 'none';
       document.getElementById('app-container').style.display = 'flex';
       
       // Set User Info
       document.getElementById('user-display').innerText = currentUser.name;
       document.getElementById('dash-name').innerText = currentUser.name;
       document.getElementById('dash-id').innerText = "ID: " + currentUser.id;
       document.getElementById('dash-img').src = currentUser.image || "";

       // Fetch Dropdowns only ONCE
       const drops = await fetchAPI('getDropdowns');
       if(drops) {
          fillSelect(['d-br','w-br','p-br'], drops.branches);
          fillSelect(['d-sup','p-sup'], drops.sups);
          fillSelect(['d-am','p-am'], drops.ams);
          fillSelect(['t-trainer'], drops.names);
       }

       // Fetch Questions
       const dQs = await fetchAPI('getQuestions', {type:'daily'});
       if(dQs) renderQs('daily-qs', dQs, 'daily');
       
       const wQs = await fetchAPI('getQuestions', {type:'weekly'});
       if(wQs) renderQs('weekly-qs', wQs, 'weekly');
    }

    // --- FORM LOGIC ---

    async function submitForm(e, cat) {
       e.preventDefault();
       const btn = e.target.querySelector('button');
       btn.innerText = "Saving..."; btn.disabled = true;

       const fd = new FormData(e.target);
       const obj = { category: cat, name: currentUser.name, empId: currentUser.id };
       fd.forEach((v,k) => obj[k] = v);

       // Training specific fix
       if(cat === 'Training') obj.category = "Training Day " + document.getElementById('t-day-val').value;

       const res = await postAPI(obj);
       alert(res.message);
       btn.innerText = "Submit"; btn.disabled = false;
       if(res.success) e.target.reset();
    }

    async function submitProblem(e) {
       e.preventDefault();
       const btn = e.target.querySelector('button');
       btn.innerText = "Uploading..."; btn.disabled = true;

       const fd = new FormData(e.target);
       const obj = { category: "Report Problem", name: currentUser.name, empId: currentUser.id };
       fd.forEach((v,k) => obj[k] = v);

       const fileInput = document.getElementById('p-file');
       if(fileInput.files.length > 0) {
          const reader = new FileReader();
          reader.readAsDataURL(fileInput.files[0]);
          reader.onload = async () => {
             obj.imageFile = reader.result;
             obj.imageName = fileInput.files[0].name;
             const res = await postAPI(obj);
             finishSubmit(res, btn, e.target);
          };
       } else {
          const res = await postAPI(obj);
          finishSubmit(res, btn, e.target);
       }
    }

    function finishSubmit(res, btn, form) {
       alert(res.message);
       btn.innerText = "Submit Report"; btn.disabled = false;
       if(res.success) form.reset();
    }

    // --- DYNAMIC UI ---

    function checkUrg(el) {
       const map = {"Maintenance":"High Priority", "Team Member":"Low Priority", "Customer Complaint":"Medium Priority"};
       document.getElementById('urg').value = map[el.value] || "Review";
       document.getElementById('other-div').style.display = (el.value === "Others") ? "block" : "none";
    }

    async function loadTrainQs(day) {
       if(!day) { document.getElementById('t-form').style.display = 'none'; return; }
       
       document.getElementById('t-qs-area').innerHTML = "Loading...";
       document.getElementById('t-form').style.display = 'block';
       document.getElementById('t-day-val').value = day;

       const qs = await fetchAPI('getTrainingQuestions', {day: day});
       if(qs) {
          document.getElementById('t-qs-area').innerHTML = qs.map((q,i) => 
             `<div style="margin-bottom:10px; border-bottom:1px solid #eee;">${q}<br>
              <label style="display:inline"><input type="radio" name="q_${i}" value="Pass" required> Pass</label>
              <label style="display:inline"><input type="radio" name="q_${i}" value="Fail"> Fail</label>
             </div>`
          ).join('');
       }
    }

    async function loadDashData() {
       document.getElementById('dash-list').innerText = "Loading...";
       const res = await fetchAPI('getDashboardData', {role: currentUser.role, id: currentUser.id});
       if(res && res.daily) {
          if(res.daily.length === 0) document.getElementById('dash-list').innerText = "No reports found.";
          else document.getElementById('dash-list').innerHTML = res.daily.map(d => `<div><b>${d.date}</b>: ${d.name} (${d.status})</div>`).join('');
       }
    }

    // --- UTILS ---
    function show(id) {
       document.querySelectorAll('.form-card').forEach(c => c.classList.remove('active'));
       document.getElementById(id).classList.add('active');
       document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
       event.currentTarget.classList.add('active');
    }
    function logout() { location.reload(); }
    function load(v) { document.getElementById('loader').style.display = v ? 'flex' : 'none'; }
    function fillSelect(ids, list) {
       ids.forEach(id => {
          const el = document.getElementById(id);
          if(el) el.innerHTML = list.map(i => `<option>${i}</option>`).join('');
       });
    }
    function renderQs(id, list, pre) {
       document.getElementById(id).innerHTML = list.map((q,i) => 
          `<div style="margin-bottom:10px; background:#f9fafb; padding:10px;">${i+1}. ${q}<br>
           ${pre==='daily' 
             ? `<label style="display:inline"><input type="radio" name="${pre}_q_${i}" value="Yes"> Yes</label><label style="display:inline"><input type="radio" name="${pre}_q_${i}" value="No"> No</label>`
             : `<input name="${pre}_q_${i}" placeholder="Answer...">`}
           </div>`
       ).join('');
    }

    // --- API HANDLERS ---
    async function fetchAPI(act, p={}) {
       const u = new URL(API_URL);
       u.searchParams.append('action', act);
       for(let k in p) u.searchParams.append(k, p[k]);
       const r = await fetch(u);
       return await r.json();
    }
    async function postAPI(data) {
       const r = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
       return await r.json();
    }
  </script>
</body>
</html>
