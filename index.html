<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>BON Cafe  Team Leaders</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* CORE VARIABLES */
    :root { --primary: #10b981; --primary-dark: #059669; --bg: #f3f4f6; --surface: #ffffff; --sidebar-bg: #111827; --text: #1f2937; --text-light: #6b7280; --border: #e5e7eb; --radius: 12px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); --danger: #ef4444; --warning: #f59e0b; --success: #10b981; }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; display: flex; }
    
    /* SIDEBAR */
    .sidebar { width: 260px; background: var(--sidebar-bg); color: white; height: 100vh; position: fixed; left: 0; top: 0; transition: transform 0.3s ease; z-index: 1000; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.closed { transform: translateX(-260px); }
    .logo-area { padding: 30px 20px; font-weight: 700; font-size: 1.1rem; border-bottom: 1px solid #374151; display: flex; align-items: center; justify-content: space-between; cursor: pointer; letter-spacing: 0.5px; color: var(--primary); }
    .nav-links { list-style: none; padding: 20px 10px; overflow-y: auto; flex: 1; }
    .nav-item { padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #d1d5db; transition: all 0.2s; }
    .nav-item:hover { background: rgba(255,255,255,0.08); color: white; transform: translateX(3px); }
    .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .nav-item i { font-size: 22px; }

    /* CONTENT */
    .main-wrapper { flex: 1; margin-left: 260px; height: 100vh; display: flex; flex-direction: column; transition: margin-left 0.3s ease; width: 100%; }
    .main-wrapper.full { margin-left: 0; }
    .content-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; }
    .mobile-menu-btn { padding: 5px; color: var(--text); font-size: 32px; cursor: pointer; border-radius: 4px; transition: 0.2s; }
    .mobile-menu-btn:hover { background: #e5e7eb; color: var(--primary); }
    .page-header-title { font-size: 1.4rem; font-weight: 800; color: #111827; margin: 0; flex: 1; }
    .bell-wrapper { position: relative; cursor: pointer; margin-right: 10px; }
    .bell-icon { font-size: 28px; color: var(--text); }
    .bell-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; font-size: 0.7rem; font-weight: 700; width: 18px; height: 18px; display: flex; justify-content: center; align-items: center; border: 2px solid white; display: none; }
    
    .content-area { flex: 1; padding: 20px 30px; overflow-y: auto; overflow-x: hidden; position: relative; display: flex; flex-direction: column; }
    .form-section { display: none; animation: slideUp 0.3s ease-out; max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); width: 100%; }
    .form-section.active { display: block; }

    /* ADMIN DASHBOARD STYLES */
    .admin-nav { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
    .admin-tab-btn { padding: 10px 20px; border-radius: 20px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 600; color: var(--text-light); transition: 0.2s; }
    .admin-tab-btn:hover { background: #f3f4f6; color: var(--primary); }
    .admin-tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 6px rgba(16,185,129,0.3); }

    .admin-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; background: #f9fafb; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .admin-filters input, .admin-filters select { width: 100%; margin: 0; padding: 10px; font-size: 0.9rem; }
    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700; background: #d1fae5; color: #065f46; border: 1px solid #34d399; }

    /* UI ELEMENTS */
    .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid var(--border); margin-top: 15px; }
    .history-table { width: 100%; border-collapse: collapse; min-width: 600px; }
    .history-table th, .history-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
    .history-table th { background: #f9fafb; font-weight: 600; color: #374151; white-space: nowrap; }
    .history-table tr:hover { background: #fdfdfd; }
    
    .submit-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1.05rem; letter-spacing: 0.5px; }
    .action-btn { background: var(--bg); color: var(--text); border: 2px solid var(--border); padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-bottom: 20px; }

    /* COMPONENTS */
    #login-overlay { position: fixed; inset: 0; background: var(--sidebar-bg); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .login-box { background: white; padding: 40px 30px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    
    .tl-header { display: flex; align-items: center; gap: 30px; background: #f9fafb; padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--border); }
    .tl-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 5px solid var(--primary); box-shadow: var(--shadow); }
    .tl-graph-box { flex: 1; min-width: 250px; background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .prog-track { height: 20px; background: #e5e7eb; border-radius: 10px; margin-top: 15px; overflow: hidden; position: relative; }
    .prog-fill { height: 100%; background: linear-gradient(90deg, #10b981, #059669); width: 0%; transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .prog-txt { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: block; margin-top: 5px; text-align: right; }

    .category-list { display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; width: 100%; }
    .cat-card { background: white; padding: 20px 25px; border-radius: var(--radius); box-shadow: var(--shadow); cursor: pointer; transition: 0.2s; border: 1px solid transparent; width: 100%; display: flex; align-items: center; gap: 20px; }
    .cat-card i { font-size: 32px; color: var(--primary); background: #ecfdf5; padding: 10px; border-radius: 50%; }

    .training-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; }
    .day-card { border: 2px solid var(--border); padding: 20px 10px; text-align: center; border-radius: 12px; cursor: pointer; background: white; font-weight: 600; }
    .day-num { font-size: 1.5rem; color: var(--primary); display: block; margin-bottom: 5px; }
    
    .announce-card { border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #fff; border-left: 5px solid var(--primary); }
    .ac-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
    .ac-btn-read { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }

    .custom-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
    .custom-modal-overlay.open { display: flex; opacity: 1; }
    .custom-modal-box { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 16px; text-align: center; transform: scale(0.9); transition: transform 0.3s; }
    .custom-modal-overlay.open .custom-modal-box { transform: scale(1); }
    .c-modal-icon { font-size: 50px; margin-bottom: 15px; }
    .c-modal-btns { display: flex; gap: 10px; justify-content: center; }
    .c-btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; flex: 1; }
    .c-btn-primary { background: var(--primary); color: white; }
    .c-btn-cancel { background: #e5e7eb; color: var(--text); }
    .mod-success .c-modal-icon { color: var(--success); }

    .question-block { background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); }
    .q-options { display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
    .hidden-input { display: none; margin-top: 15px; animation: fadeIn 0.3s; }
    input, select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; background: #f9fafb; outline: none; }
    .form-group { margin-bottom: 20px; }

    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); width: 280px; }
      .sidebar.mobile-open { transform: translateX(0); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
      .main-wrapper { margin-left: 0; width: 100%; }
      .admin-filters { grid-template-columns: 1fr; }
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <!-- MODAL -->
  <div class="custom-modal-overlay" id="c-modal">
    <div class="custom-modal-box" id="c-modal-box">
       <i class="material-icons c-modal-icon" id="c-icon">check_circle</i>
       <div style="font-size:1.5rem; font-weight:700; margin-bottom:10px;" id="c-title">Success</div>
       <div style="color:#666; margin-bottom:20px;" id="c-msg">Operation completed.</div>
       <div class="c-modal-btns" id="c-btns"></div>
    </div>
  </div>

  <div id="login-overlay">
    <div class="login-box">
       <h2 style="margin-bottom:20px;">BON PORTAL</h2>
       <div class="form-group"><input type="text" id="login-u" placeholder="Username"></div>
       <div class="form-group"><input type="password" id="login-p" placeholder="Password"></div>
       <button class="submit-btn" onclick="doLogin()">Login</button>
       <div style="margin-top:20px; font-size:0.9rem; color:#666; cursor:pointer; text-decoration:underline;" onclick="toggleAdmin()">Toggle Admin/User</div>
    </div>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="logo-area" onclick="showTab('landing')">
      <span id="welcome-msg">Welcome</span> 
      <i class="material-icons" onclick="toggleMenu()" style="cursor:pointer; display:none; color:white;" id="mobile-close-btn">close</i>
    </div>
    <ul class="nav-links">
      <li class="nav-item tl-only active" onclick="showTab('landing')"><i class="material-icons">home</i> Home</li>
      <li class="nav-item tl-only" onclick="showTab('announce-view')"><i class="material-icons">campaign</i> Announcements</li>
      <li class="nav-item tl-only" onclick="showTab('tl-dash')"><i class="material-icons">dashboard</i> My Dashboard</li>
      <li class="nav-item tl-only" onclick="showTab('daily')"><i class="material-icons">today</i> Daily Task</li>
      <li class="nav-item tl-only" onclick="showTab('weekly')"><i class="material-icons">event_note</i> Weekly Task</li>
      <li class="nav-item tl-only" onclick="showTab('problem')"><i class="material-icons">report_problem</i> Report Problem</li>
      <li class="nav-item tl-only" onclick="showTab('vacation')"><i class="material-icons">flight</i> Vacation</li>
      <li class="nav-item tl-only" onclick="confirmTraining()"><i class="material-icons">school</i> 9-Days Training</li>
      <li class="nav-item tl-only" onclick="showHistory()"><i class="material-icons">history</i> Training History</li>
      <li class="nav-item admin-only" style="display:none;" onclick="showTab('admin-dash')"><i class="material-icons">analytics</i> Global Dashboard</li>
      <li class="nav-item admin-only" style="display:none;" onclick="showTab('admin-post-ann')"><i class="material-icons">campaign</i> Post Announcement</li>
      <li style="margin-top:auto; border-top:1px solid #374151;" class="nav-item" onclick="confirmLogout()"><i class="material-icons">logout</i> Logout</li>
    </ul>
  </div>

  <div class="main-wrapper" id="main-wrapper">
    <div class="content-area">
      <div class="content-header">
         <i class="material-icons mobile-menu-btn" onclick="toggleMenu()">menu</i>
         <h1 class="page-header-title" id="dynamic-title">Home</h1>
         <div class="bell-wrapper" onclick="showTab('announce-view')">
            <i class="material-icons bell-icon">notifications_none</i>
            <span class="bell-badge" id="bell-count">0</span>
         </div>
      </div>

      <!-- LANDING -->
      <div id="landing" class="landing-wrapper active">
         <div style="text-align:center; padding:50px 20px; color:#666;">Welcome to Bon Cafe Portal</div>
         <div class="category-list tl-only">
             <div class="cat-card" onclick="showTab('tl-dash')"><i class="material-icons">dashboard</i><span>My Dashboard</span></div>
             <div class="cat-card" onclick="showTab('daily')"><i class="material-icons">today</i><span>Daily Task</span></div>
             <div class="cat-card" onclick="showTab('weekly')"><i class="material-icons">event_note</i><span>Weekly Task</span></div>
         </div>
         <div class="category-list admin-only" style="display:none;">
             <div class="cat-card" onclick="showTab('admin-dash')"><i class="material-icons">analytics</i><span>Global Dashboard</span></div>
             <div class="cat-card" onclick="showTab('admin-post-ann')"><i class="material-icons">campaign</i><span>Post Announcement</span></div>
         </div>
      </div>

      <!-- NEW: ADMIN DASHBOARD -->
      <div id="admin-dash" class="form-section">
         <h2>Global Dashboard</h2>
         <div class="admin-nav">
             <button class="admin-tab-btn active" onclick="switchAdminTab('Daily Task')">Daily Task</button>
             <button class="admin-tab-btn" onclick="switchAdminTab('Weekly Task')">Weekly Task</button>
             <button class="admin-tab-btn" onclick="switchAdminTab('Problems')">Problems</button>
             <button class="admin-tab-btn" onclick="switchAdminTab('Vacation')">Vacations</button>
             <button class="admin-tab-btn" onclick="switchAdminTab('Trainings')">Trainings</button>
             <button class="admin-tab-btn" onclick="switchAdminTab('Announcement')">Announcement</button>
         </div>
         <div class="admin-filters">
            <div><label>Start</label><input type="date" id="ad-start"></div>
            <div><label>End</label><input type="date" id="ad-end"></div>
            <div><label>TL Name/ID</label><input type="text" id="ad-tl"></div>
            <div><label>Trainee Name</label><input type="text" id="ad-mem"></div>
            <div><label>Branch</label><select id="ad-branch" class="db-branch"></select></div>
            <div><label>Sup</label><select id="ad-sup" class="db-sup"></select></div>
            <div><label>AM</label><select id="ad-am" class="db-am"></select></div>
            <div style="justify-content:end;"><button class="submit-btn" style="margin-top:auto;" onclick="loadAdminData()">Apply</button></div>
         </div>
         <div class="table-responsive"><table class="history-table"><thead id="ad-thead"></thead><tbody id="ad-tbody"></tbody></table></div>
      </div>

      <!-- TL DASHBOARD -->
      <div id="tl-dash" class="form-section">
         <h2>My Performance</h2>
         <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="date" id="tl-start"> <input type="date" id="tl-end">
            <button class="submit-btn" style="width:auto;" onclick="loadTLData()">Refresh</button>
         </div>
         <div class="tl-header">
            <img id="tl-pic" src="" class="tl-img" onerror="this.src='https://via.placeholder.com/100'">
            <div><h2 id="tl-name">Name</h2><p id="tl-id">ID</p></div>
            <div class="tl-graph-box"><div class="prog-track"><div id="tl-bar" class="prog-fill"></div></div><div id="tl-score" class="prog-txt">0%</div></div>
         </div>
         <h3>Submissions</h3>
         <div class="table-responsive"><table class="history-table"><thead><tr><th>Date</th><th>Type</th><th>Status</th></tr></thead><tbody id="tl-daily-body"></tbody></table></div>
      </div>

      <!-- FORMS -->
      <div id="daily" class="form-section">
        <h2>Daily Task</h2>
        <form onsubmit="handleDynamicSubmit(event, 'Daily Task')">
           <div class="form-group"><label>Name</label><input class="u-name" name="name" readonly></div>
           <div class="form-group"><label>Branch</label><select class="db-branch" name="branch" required></select></div>
           <div class="form-group"><label>Supervisor</label><select class="db-sup" name="supervisor" required></select></div>
           <div class="form-group"><label>Area Manager</label><select class="db-am" name="areaManager" required></select></div>
           <div id="daily-questions">Loading...</div>
           <button class="submit-btn">Submit Daily Task</button>
        </form>
      </div>

      <div id="weekly" class="form-section">
        <h2>Weekly Report</h2>
        <form onsubmit="handleDynamicSubmit(event, 'Weekly Task')">
           <div class="form-group"><label>Name</label><input class="u-name" name="name" readonly></div>
           <div class="form-group"><label>Branch</label><select class="db-branch" name="branch" required></select></div>
           <div class="form-group"><label>Week Ending</label><input type="date" name="weekDate" required></div>
           <div id="weekly-questions">Loading...</div>
           <button class="submit-btn">Submit Weekly Report</button>
        </form>
      </div>

      <div id="problem" class="form-section">
        <h2>Report Issue</h2>
        <form onsubmit="handleProblem(event)">
          <div class="form-group"><label>Name</label><input class="u-name" name="name" readonly></div>
          <div class="form-group"><label>Issue Type</label><select name="issueType" onchange="checkIssue(this)" required><option value="Maintenance">Maintenance</option><option value="Others">Others</option></select></div>
          <div class="form-group" id="div-oth" style="display:none;"><input type="text" name="issueTypeOther" placeholder="Specify"></div>
          <div class="form-group"><label>Urgency</label><input id="urg-lbl" name="urgency" value="High Priority" readonly></div>
          <div class="form-group"><textarea name="description" rows="3" placeholder="Description" required></textarea></div>
          <div class="form-group"><input type="file" id="p-img" accept="image/*"></div>
          <button class="submit-btn">Submit Report</button>
        </form>
      </div>

      <div id="vacation" class="form-section">
        <h2>Request Vacation</h2>
        <form onsubmit="handleDynamicSubmit(event, 'Vacation')">
           <div class="form-group"><label>Name</label><input class="u-name" name="name" readonly></div>
           <div class="form-group"><label>Start</label><input type="date" name="startDate" required></div>
           <div class="form-group"><label>End</label><input type="date" name="endDate" required></div>
           <div class="form-group"><label>Reason</label><input type="text" name="reason" required></div>
           <button class="submit-btn">Submit</button>
        </form>
      </div>

      <!-- TRAINING SECTIONS -->
      <div id="training-dash" class="form-section">
        <h2 style="display:flex; justify-content:space-between; align-items:center;">9-Days Training</h2>
        <button class="action-btn" onclick="showTab('trainee-reg-view')"><i class="material-icons" style="color:var(--primary);">person_add</i> Add New Team Member</button>
        <div class="training-grid">
           <div class="day-card" onclick="loadTraineesAndOpenDay(1)"><span class="day-num">1</span> Day One</div>
           <div class="day-card" onclick="loadTraineesAndOpenDay(2)"><span class="day-num">2</span> Day Two</div>
           <div class="day-card" onclick="loadTraineesAndOpenDay(3)"><span class="day-num">3</span> Day Three</div>
           <div class="day-card" onclick="loadTraineesAndOpenDay(4)"><span class="day-num">4</span> Day Four</div>
           <div class="day-card" onclick="loadTraineesAndOpenDay(5)"><span class="day-num">5</span> Day Five</div>
           <div class="day-card" onclick="loadTraineesAndOpenDay(6)"><span class="day-num">6</span> Day Six</div>
           <div class="day-card" onclick="loadTraineesAndOpenDay(7)"><span class="day-num">7</span> Day Seven</div>
           <div class="day-card" onclick="loadTraineesAndOpenDay(8)"><span class="day-num">8</span> Day Eight</div>
           <div class="day-card" onclick="loadTraineesAndOpenDay(9)"><span class="day-num">9</span> Day Nine</div>
        </div>
      </div>

      <div id="trainee-reg-view" class="form-section">
        <div onclick="showTab('training-dash')" style="cursor:pointer; margin-bottom:20px; color:#6b7280; font-weight:600; display:flex; align-items:center;"><i class="material-icons">arrow_back</i> Back to Grid</div>
        <h2>Register Team Member</h2>
        <form onsubmit="handleDynamicSubmit(event, 'Trainee Registration')">
           <div class="form-group"><label>Team Leader (You)</label><input class="u-name" name="teamLeader" readonly></div>
           <div class="form-group"><label>Employee ID</label><input type="text" name="traineeId" required></div>
           <div class="form-group"><label>Full Name</label><input type="text" name="traineeName" required></div>
           <div class="form-group"><label>Email</label><input type="email" name="traineeEmail" required></div>
           <div class="form-group"><label>Nationality</label><input type="text" name="nationality" required></div>
           <div class="form-group"><label>Status</label><select name="empStatus"><option value="New">New</option><option value="Old">Old</option></select></div>
           <div class="form-group"><label>Branch</label><select class="db-branch" name="branch" required></select></div>
           <div class="form-group"><label>Supervisor</label><select class="db-sup" name="supervisor" required></select></div>
           <div class="form-group"><label>Area Manager</label><select class="db-am" name="areaManager" required></select></div>
           <div class="form-group"><label>Area</label><select name="area"><option value="Jeddah">Jeddah</option><option value="Makkah">Makkah</option></select></div>
           <button class="submit-btn">Save Team Member</button>
        </form>
      </div>

      <div id="training-dynamic" class="form-section">
        <div onclick="showTab('training-dash')" style="cursor:pointer; margin-bottom:20px; color:#6b7280; font-weight:600; display:flex; align-items:center;"><i class="material-icons">arrow_back</i> Back to Grid</div>
        <h2 id="training-title">Training Day</h2>
        <form id="dynamic-form" onsubmit="handleDynamicSubmit(event, 'Training')">
          <input type="hidden" name="category" id="train-cat">
          <div class="form-group"><label>Trainee ID</label><select id="trainee-dropdown" name="traineeId" required onchange="onTraineeSelect(this)"><option value="" disabled selected>Select Trainee ID</option></select></div>
          <div class="form-group"><label>Name</label><input type="text" id="t-name-auto" name="traineeName" readonly></div>
          <div class="form-group"><label>Email</label><input type="text" id="t-email-auto" name="traineeEmail" readonly></div>
          <div class="form-group"><label>Trainer</label><input class="u-name" name="trainerName" readonly></div>
          <div id="questions-container">Loading...</div>
          <div class="form-group"><label>Notes</label><textarea name="notes" rows="3"></textarea></div>
          <button class="submit-btn">Submit Evaluation</button>
        </form>
      </div>

      <div id="history-view" class="form-section">
        <h2>Records</h2>
        <div class="admin-filters" style="grid-template-columns: 2fr 1fr;">
           <input list="dl-ids" id="hist-id" placeholder="Filter by Employee ID">
           <button class="submit-btn" onclick="fetchHistory()">Filter</button>
        </div>
        <div id="progress-section" style="margin-top:20px;"></div>
        <div class="table-responsive"><table class="history-table"><thead id="hist-head"><tr><th>Date</th><th>Day</th><th>Name</th><th>ID</th><th>Trainer</th><th>Notes</th></tr></thead><tbody id="history-body"></tbody></table></div>
      </div>
      
      <!-- ANNOUNCEMENTS -->
      <div id="announce-view" class="form-section"><h2>Announcements</h2><div id="announcement-list"></div></div>
      <div id="admin-post-ann" class="form-section">
         <h2>Post Announcement</h2>
         <form onsubmit="handleDynamicSubmit(event, 'Announcements')">
            <div class="form-group"><label>Title</label><input type="text" name="title" required></div>
            <div class="form-group"><label>Date</label><input type="date" name="effDate" required></div>
            <div class="form-group"><label>Message</label><textarea name="message" rows="4" required></textarea></div>
            <input class="u-name" name="name" type="hidden">
            <button class="submit-btn">Post</button>
         </form>
      </div>

    </div>
  </div>
  
  <datalist id="dl-ids"></datalist>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyRtDjSzUxjygsRpcKe20a0m_ytOazLh5_SWuwIfGy456UmGjtFo_4pJqk7e0M41jkKpA/exec";
    let currentUser = null; 
    let isAdminMode = false;
    let globalTraineeList = [];
    let currentAdminTab = 'Daily Task';

    // --- ADMIN PANEL LOGIC ---
    function switchAdminTab(tab) {
        currentAdminTab = tab;
        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.innerText === tab || (tab === 'Announcement' && btn.innerText === 'Announcement'));
        });
        loadAdminData();
    }

    async function loadAdminData() {
        const tbody = document.getElementById('ad-tbody');
        const thead = document.getElementById('ad-thead');
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Loading data...</td></tr>';
        
        const filters = {
            role: 'Admin',
            category: currentAdminTab,
            start: document.getElementById('ad-start').value,
            end: document.getElementById('ad-end').value,
            tlName: document.getElementById('ad-tl').value,
            memName: document.getElementById('ad-mem').value,
            branch: document.getElementById('ad-branch').value,
            sup: document.getElementById('ad-sup').value,
            am: document.getElementById('ad-am').value
        };

        const res = await fetchAPI('getDashboardData', filters);
        const data = res.categoryData;

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No records found.</td></tr>';
            return;
        }

        let headHTML = '';
        let bodyHTML = '';

        if (currentAdminTab === 'Daily Task' || currentAdminTab === 'Weekly Task') {
            headHTML = `<tr><th>Date</th><th>Team Leader</th><th>Branch</th><th>Supervisor</th><th>Area Manager</th><th>Status</th></tr>`;
            bodyHTML = data.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.tl}</td>
                    <td>${r.branch}</td>
                    <td>${r.sup}</td>
                    <td>${r.am}</td>
                    <td><span class="status-badge">${r.status}</span></td>
                </tr>`).join('');
        } 
        else if (currentAdminTab === 'Problems') {
            headHTML = `<tr><th>Date</th><th>Team Leader</th><th>Branch</th><th>Sup</th><th>Issue</th><th>Urgency</th><th>Details</th></tr>`;
            bodyHTML = data.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.tl}</td>
                    <td>${r.branch}</td>
                    <td>${r.sup}</td>
                    <td>${r.issue}</td>
                    <td>${r.urg}</td>
                    <td>${r.desc} ${r.img !== 'No Image' ? `<a href="${r.img}" target="_blank">[IMG]</a>` : ''}</td>
                </tr>`).join('');
        }
        else if (currentAdminTab === 'Vacations') {
            headHTML = `<tr><th>Date</th><th>Team Leader</th><th>Start</th><th>End</th><th>Reason</th></tr>`;
            bodyHTML = data.map(r => `
                <tr><td>${r.date}</td><td>${r.tl}</td><td>${r.start}</td><td>${r.end}</td><td>${r.reason}</td></tr>`).join('');
        }
        else if (currentAdminTab === 'Trainings') {
            headHTML = `<tr><th>Date</th><th>Day</th><th>Trainer (TL)</th><th>Trainee</th><th>ID</th><th>Notes</th></tr>`;
            bodyHTML = data.map(r => `
                <tr><td>${r.date}</td><td>${r.day}</td><td>${r.trainer}</td><td>${r.trainee}</td><td>${r.id}</td><td>${r.notes}</td></tr>`).join('');
        }
        else if (currentAdminTab === 'Announcement') {
            headHTML = `<tr><th>ID</th><th>Date</th><th>Title</th><th>Message</th><th>By</th></tr>`;
            bodyHTML = data.map(r => `<tr><td>${r.id}</td><td>${r.date}</td><td>${r.title}</td><td>${r.msg}</td><td>${r.by}</td></tr>`).join('');
        }

        thead.innerHTML = headHTML;
        tbody.innerHTML = bodyHTML;
    }

    // --- TL / USER LOGIC ---
    async function loadTLData() {
       document.getElementById('tl-name').innerText = currentUser.name; 
       document.getElementById('tl-id').innerText = currentUser.id;
       document.getElementById('tl-pic').src = currentUser.image || "https://via.placeholder.com/100";
       
       const res = await fetchAPI('getDashboardData', {viewerId:currentUser.id, role:'User', start:document.getElementById('tl-start').value, end:document.getElementById('tl-end').value});
       
       const dailyHTML = res.daily.length ? res.daily.map(r=>`<tr><td>${r.date}</td><td>Daily</td><td><span class="status-badge">${r.status}</span></td></tr>`).join('') : '<tr><td colspan="3">No Data</td></tr>';
       document.getElementById('tl-daily-body').innerHTML = dailyHTML;
       
       let score = Math.min(100, (res.daily.length * 5));
       document.getElementById('tl-bar').style.width = score + "%";
       document.getElementById('tl-score').innerText = score + "%";
    }

    // --- TRAINING LOGIC ---
    async function loadTraineesAndOpenDay(day) {
        showTab('training-dynamic');
        document.getElementById('training-title').innerText = "Training Day " + day; 
        document.getElementById('train-cat').value = "Training Day " + day;
        document.getElementById('trainee-dropdown').innerHTML = '<option value="" disabled selected>Loading...</option>';
        document.getElementById('t-name-auto').value = ""; 
        document.getElementById('t-email-auto').value = "";
        
        globalTraineeList = await fetchAPI('getTraineeList');
        const dd = document.getElementById('trainee-dropdown');
        if(globalTraineeList.length > 0) {
           dd.innerHTML = '<option value="" disabled selected>Select Trainee ID</option>' + globalTraineeList.map(t => `<option value="${t.id}">${t.id}</option>`).join('');
        } else {
           dd.innerHTML = '<option value="" disabled selected>No Trainees Found</option>';
        }

        const div = document.getElementById('questions-container');
        div.innerHTML = 'Loading questions...';
        const qs = await fetchAPI('getTrainingQuestions', {day: day});
        div.innerHTML = qs.map((q,i) => `
           <div class="form-group" style="background:#f9f9f9; padding:15px; border-radius:8px;">
             <label>${i+1}. ${q}</label>
             <div style="display:flex; gap:15px;">
               <label><input type="radio" name="q_${i}" value="Pass" required> Pass</label>
               <label><input type="radio" name="q_${i}" value="Fail"> Fail</label>
               <label><input type="radio" name="q_${i}" value="Retrain"> Retrain</label>
             </div>
           </div>`).join('');
    }

    function onTraineeSelect(el) {
       const t = globalTraineeList.find(x => String(x.id) === String(el.value));
       if (t) {
          document.getElementById('t-name-auto').value = t.name;
          document.getElementById('t-email-auto').value = t.email;
       }
    }

    // --- SECURITY FIX: HISTORY ---
    async function fetchHistory() {
      const id = document.getElementById('hist-id').value;
      // SENDING VIEWER CREDENTIALS FOR SECURITY
      const data = await fetchAPI('getTrainingHistory', {
          id: id, 
          viewerName: currentUser.name, 
          role: currentUser.role
      });
      document.getElementById('history-body').innerHTML = data.length ? data.map(r=>`<tr><td>${r.date}</td><td>${r.day}</td><td>${r.name}</td><td>${r.id}</td><td>${r.trainer}</td><td>${r.notes}</td></tr>`).join('') : '<tr><td colspan="6">No records</td></tr>';
      
      const trainees = {};
      data.forEach(r => { if(!trainees[r.id]) trainees[r.id] = {name:r.name, days:new Set()}; const dNum = r.day.match(/\d+/); if(dNum) trainees[r.id].days.add(parseInt(dNum[0])); });
      let pHTML = '<div class="training-grid">';
      for (const [tid, info] of Object.entries(trainees)) {
         const pct = Math.min((info.days.size / 9)*100, 100);
         pHTML += `<div class="day-card" style="text-align:left;">
            <div><strong>${info.name}</strong></div><small>ID: ${tid}</small>
            <div class="prog-track" style="height:10px; margin-top:10px;"><div class="prog-fill" style="width:${pct}%"></div></div>
            <div style="text-align:right; font-size:0.8rem; margin-top:5px; color:var(--primary);">${Math.round(pct)}%</div>
         </div>`;
      }
      pHTML += '</div>';
      document.getElementById('progress-section').innerHTML = pHTML;
    }

    // --- STANDARD APP FUNCTIONS ---
    function showTab(id) {
       document.querySelectorAll('.form-section, .landing-wrapper').forEach(e => e.classList.remove('active'));
       document.getElementById(id).classList.add('active');
       document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
       const btn = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick').includes(id));
       if(btn) btn.classList.add('active');
       if(window.innerWidth <= 768) { document.getElementById('sidebar').classList.remove('mobile-open'); document.getElementById('mobile-close-btn').style.display = 'none'; }
       if(id === 'announce-view') fetchAnnouncements();
       // Auto load admin data if tab matches
       if(id === 'admin-dash' && isAdminMode) loadAdminData();
    }
    
    function toggleAdmin() { isAdminMode = !isAdminMode; document.querySelector('#login-overlay h2').innerText = isAdminMode ? "Admin Login" : "Portal Login"; }
    async function doLogin() {
       const u = document.getElementById('login-u').value; const p = document.getElementById('login-p').value;
       const btn = document.querySelector('#login-overlay button'); btn.innerText = "Checking...";
       const res = await fetchAPI('handleLogin', {username:u, password:p});
       if(res.success) {
           currentUser = res; document.getElementById('login-overlay').style.display = 'none';
           initApp(); showTab(res.role === 'Admin' ? 'admin-dash' : 'landing');
       } else { showModal('error', 'Login Failed', res.message); btn.innerText = "Login"; }
    }
    function confirmLogout() { showModal('confirm', 'Confirm Logout', 'Logout?', () => location.reload()); }

    async function initApp() {
       document.getElementById('welcome-msg').innerText = "Hi " + currentUser.name.split(' ')[0]; 
       document.querySelectorAll('.u-name').forEach(el => el.value = currentUser.name);
       document.querySelectorAll('.u-id').forEach(el => el.value = currentUser.id);
       const roleClass = currentUser.role === 'Admin' ? '.admin-only' : '.tl-only';
       const hideClass = currentUser.role === 'Admin' ? '.tl-only' : '.admin-only';
       document.querySelectorAll(roleClass).forEach(e=>e.style.display='flex');
       document.querySelectorAll(hideClass).forEach(e=>e.style.display='none');
       
       const d = await fetchAPI('getGlobalDropdowns');
       if(d) {
          const fills = (cls, data) => document.querySelectorAll(cls).forEach(sel => { sel.innerHTML = '<option value="">All/Select</option>' + data.map(i=>`<option value="${i}">${i}</option>`).join(''); });
          fills('.db-branch', d.branches); fills('.db-sup', d.sups); fills('.db-am', d.ams);
       }
       
       const dq = await fetchAPI('getQuestions', {sheetName:'Daily Config'}); renderDailyQuestions('daily-questions', dq);
       const wq = await fetchAPI('getQuestions', {sheetName:'Weekly Config'}); renderWeeklyQuestions('weekly-questions', wq);
    }

    async function fetchAnnouncements() {
        const list = document.getElementById('announcement-list'); const badge = document.getElementById('bell-count');
        const res = await fetchAPI('getAnnouncements', {userId: currentUser.id});
        const unread = res.filter(a => !a.isRead).length;
        badge.style.display = unread > 0 ? 'flex' : 'none'; badge.innerText = unread;
        list.innerHTML = res.length ? res.map(a => `<div class="announce-card"><div class="ac-header"><span class="ac-date">${a.date}</span>${a.isRead?'âœ”':''}</div><div class="ac-title">${a.title}</div><div>${a.message}</div>${!a.isRead?`<button class="ac-btn-read" onclick="markRead('${a.id}',this)">OK</button>`:''}</div>`).join('') : '<p>No Announcements</p>';
    }
    async function markRead(id, btn) { btn.innerText='...'; await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'markRead', announcementId:id, userId:currentUser.id, userName:currentUser.name})}); fetchAnnouncements(); }

    function renderDailyQuestions(id, qs) { document.getElementById(id).innerHTML = qs.map((q,i) => `<div class="form-group" style="background:#f9f9f9; padding:10px;"><label>${i+1}. ${q}</label><div style="display:flex; gap:10px;"><label><input type="radio" name="daily_q_${i}" value="Yes" required> Yes</label><label><input type="radio" name="daily_q_${i}" value="No"> No</label></div></div>`).join(''); }
    function renderWeeklyQuestions(id, qs) { document.getElementById(id).innerHTML = qs.map((q,i) => `<div class="form-group"><label>${i+1}. ${q}</label>${i===0?`<div style="display:flex; gap:10px;"><label><input type="radio" name="weekly_q_0" value="Yes" required> Yes</label><label><input type="radio" name="weekly_q_0" value="No"> No</label></div>`:`<textarea name="weekly_q_${i}" rows="2"></textarea>`}</div>`).join(''); }
    
    function checkIssue(el) { document.getElementById('div-oth').style.display = el.value === 'Others' ? 'block' : 'none'; document.getElementById('urg-lbl').value = el.value === 'Maintenance' ? 'High Priority' : 'Medium Priority'; }
    async function handleProblem(e) { e.preventDefault(); const fd = new FormData(e.target); const obj={category:"Report Problem", name:currentUser.name, empId:currentUser.id}; fd.forEach((v,k)=>obj[k]=v); const f=document.getElementById('p-img').files[0]; if(f){const r=new FileReader();r.onload=()=>{obj.imageFile=r.result;obj.imageName=f.name;postData(obj,e.target)};r.readAsDataURL(f);}else{postData(obj,e.target);} }

    async function handleDynamicSubmit(e, cat) { e.preventDefault(); const fd=new FormData(e.target); const obj={category:cat, name:currentUser.name, empId:currentUser.id}; fd.forEach((v,k)=>obj[k]=v); postData(obj, e.target); }
    async function postData(obj, form) { 
        const btn = form.querySelector('button'); btn.disabled=true; btn.innerText="Sending...";
        const res = await fetch(API_URL, {method:'POST', body:JSON.stringify(obj)}).then(r=>r.json());
        btn.disabled=false; btn.innerText="Submit";
        if(res.success) { showModal('success', 'Done', 'Saved Successfully'); form.reset(); if(obj.category.includes("Trainee")) showTab('training-dash'); }
        else { showModal('error', 'Error', res.message); }
    }
    
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('closed'); document.getElementById('main-wrapper').classList.toggle('full'); }
    function showModal(type, t, m, cb) { const b=document.getElementById('c-modal-box'), c=document.getElementById('c-modal'); document.getElementById('c-title').innerText=t; document.getElementById('c-msg').innerText=m; const icon=document.getElementById('c-icon'); icon.innerText=type==='success'?'check_circle':'error'; b.className='custom-modal-box '+(type==='success'?'mod-success':'mod-error'); const btns=document.getElementById('c-btns'); btns.innerHTML=`<button class="c-btn c-btn-primary" onclick="document.getElementById('c-modal').classList.remove('open'); ${cb?'cb()':''}">OK</button>`; c.classList.add('open'); }
    async function fetchAPI(act, p={}) { const u = new URL(API_URL); u.searchParams.append('action', act); for(let k in p) u.searchParams.append(k, p[k]); return await fetch(u).then(r=>r.json()); }
  </script>
</body>
</html>
