<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BON Cafe Portal</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root { --primary: #10b981; --dark: #1f2937; --bg: #f3f4f6; --white: #ffffff; }
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { margin: 0; padding: 0; background: var(--bg); height: 100vh; display: flex; overflow: hidden; }

    /* LOADER */
    #global-loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* LOGIN */
    #login-view { position: fixed; inset: 0; background: var(--dark); z-index: 5000; display: flex; justify-content: center; align-items: center; }
    .login-card { background: var(--white); padding: 2rem; border-radius: 12px; width: 90%; max-width: 380px; text-align: center; }
    .login-inp { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; }
    .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .link { color: #6b7280; font-size: 0.9rem; cursor: pointer; text-decoration: underline; margin-top: 15px; display: block; }

    /* LAYOUT */
    .sidebar { width: 250px; background: var(--dark); color: white; height: 100%; display: flex; flex-direction: column; transition: 0.3s; position: fixed; z-index: 1000; }
    .sidebar.closed { transform: translateX(-100%); }
    .main { margin-left: 250px; flex: 1; display: flex; flex-direction: column; height: 100%; transition: 0.3s; width: 100%; }
    .main.full { margin-left: 0; }
    
    .nav-item { padding: 15px; cursor: pointer; display: flex; gap: 10px; color: #d1d5db; align-items: center; }
    .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: var(--primary); }
    
    .header { background: var(--white); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; }
    .content { flex: 1; padding: 20px; overflow-y: auto; }

    /* COMPONENTS */
    .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; display: none; }
    .card.active { display: block; animation: fadeUp 0.3s; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; background: #f9fafb; }
    
    /* DASHBOARD WIDGETS */
    .stats-row { display: flex; gap: 15px; margin-bottom: 20px; }
    .stat-box { flex: 1; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-num { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
    .profile-head { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; }
    .avatar { width: 80px; height: 80px; border-radius: 50%; background: #ddd; object-fit: cover; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f9fafb; font-weight: 600; }

    @media(max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0; }
      .stats-row { flex-direction: column; }
    }
  </style>
</head>
<body>

  <!-- LOADING OVERLAY -->
  <div id="global-loader"><div class="spinner"></div><p style="margin-top:10px;">Starting Portal...</p></div>

  <!-- LOGIN -->
  <div id="login-view">
    <div class="login-card">
      <h2 id="login-title">Team Leader Portal</h2>
      <input id="u" class="login-inp" placeholder="Username">
      <input id="p" type="password" class="login-inp" placeholder="Password">
      <button class="btn" onclick="tryLogin()">Login</button>
      <span class="link" onclick="toggleAdmin()">or Login as Admin?</span>
    </div>
  </div>

  <!-- APP -->
  <div class="sidebar" id="sidebar">
    <div style="padding: 20px; font-weight:bold; font-size:1.2rem; border-bottom:1px solid #374151;">BON PORTAL</div>
    <div id="nav-list">
      <div class="nav-item" onclick="nav('dashboard')"><i class="material-icons">dashboard</i> Dashboard</div>
      <div class="nav-item" onclick="nav('daily')"><i class="material-icons">today</i> Daily Task</div>
      <div class="nav-item" onclick="nav('weekly')"><i class="material-icons">event_note</i> Weekly Task</div>
      <div class="nav-item" onclick="nav('problem')"><i class="material-icons">report_problem</i> Report Problem</div>
      <div class="nav-item" onclick="nav('vacation')"><i class="material-icons">flight</i> Vacation</div>
      <div class="nav-item" onclick="nav('training-idx')"><i class="material-icons">school</i> Training</div>
      <div class="nav-item admin-only" onclick="nav('admin-stats')" style="display:none;"><i class="material-icons">analytics</i> Admin Stats</div>
    </div>
    <div style="margin-top:auto; padding:20px; border-top:1px solid #374151; display:flex; gap:10px; align-items:center;">
       <img id="mini-av" class="avatar" style="width:30px; height:30px;">
       <div style="font-size:0.8rem;"><div id="mini-name">User</div><div onclick="logout()" style="color:#9ca3af; cursor:pointer;">Logout</div></div>
    </div>
  </div>

  <div class="main" id="main">
    <div class="header">
       <i class="material-icons" style="cursor:pointer" onclick="toggleMenu()">menu</i>
       <h3 id="page-title">Dashboard</h3>
    </div>
    <div class="content">
      
      <!-- TL DASHBOARD -->
      <div id="dashboard" class="card active">
         <div class="profile-head">
            <img id="dash-img" class="avatar" src="">
            <div>
               <h2 id="dash-name" style="margin:0;">Loading...</h2>
               <p id="dash-id" style="margin:0; color:#666;">ID: ...</p>
            </div>
         </div>
         <div class="stats-row">
            <div class="stat-box">Daily Reports <div id="stat-d" class="stat-num">-</div></div>
            <div class="stat-box">Weekly Reports <div id="stat-w" class="stat-num">-</div></div>
         </div>
         <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>My History</h3>
            <button class="btn" style="width:auto; padding:5px 15px;" onclick="loadHistory()">Refresh</button>
         </div>
         <div style="overflow-x:auto;">
           <table><thead><tr><th>Date</th><th>Type</th><th>Status</th></tr></thead><tbody id="hist-body"></tbody></table>
         </div>
      </div>

      <!-- ADMIN DASHBOARD -->
      <div id="admin-stats" class="card">
         <h2>Global Dashboard</h2>
         <div style="display:flex; gap:10px; margin-bottom:15px;">
           <input type="date" id="adm-start"> <input type="date" id="adm-end">
           <button class="btn" style="width:auto;" onclick="loadAdminData()">Load</button>
         </div>
         <h3>All Daily Tasks</h3>
         <div style="max-height:300px; overflow-y:auto; border:1px solid #eee;">
            <table><thead><tr><th>Date</th><th>Name</th><th>Branch</th><th>Status</th></tr></thead><tbody id="adm-daily"></tbody></table>
         </div>
      </div>

      <!-- REPORT PROBLEM -->
      <div id="problem" class="card">
        <h2>Report a Problem</h2>
        <form onsubmit="submitForm(event, 'Report Problem')">
          <div class="form-group"><label>Supervisor</label><input list="ls-sup" name="supervisor" required></div>
          <div class="form-group"><label>Branch</label><input list="ls-branch" name="branch" required></div>
          <div class="form-group"><label>Area Manager</label><input list="ls-am" name="areaManager" required></div>
          <div class="form-group">
             <label>Issue Type</label>
             <select name="issueType" onchange="handleIssueType(this)">
               <option>Maintenance</option><option>Team Member</option>
               <option>Customer Complaint</option><option>Others</option>
             </select>
          </div>
          <div id="div-other" class="form-group" style="display:none;"><input placeholder="Specify Other..." name="issueTypeOther"></div>
          <div class="form-group"><label>Urgency</label><input id="urgency" name="urgency" value="High Priority" readonly style="background:#eee;"></div>
          <div class="form-group"><label>Description</label><textarea name="description" required></textarea></div>
          <div class="form-group"><label>Photo</label><input type="file" id="f-file" accept="image/*"></div>
          <button class="btn">Submit Report</button>
        </form>
      </div>

      <!-- DAILY -->
      <div id="daily" class="card">
        <h2>Daily Task</h2>
        <form onsubmit="submitForm(event, 'Daily Task')">
           <div class="form-group"><label>Branch</label><input list="ls-branch" name="branch" required></div>
           <div class="form-group"><label>Supervisor</label><input list="ls-sup" name="supervisor" required></div>
           <div class="form-group"><label>Area Manager</label><input list="ls-am" name="areaManager" required></div>
           <div id="cont-daily">Loading...</div>
           <button class="btn">Submit</button>
        </form>
      </div>

      <!-- WEEKLY -->
      <div id="weekly" class="card">
        <h2>Weekly Task</h2>
        <form onsubmit="submitForm(event, 'Weekly Task')">
           <div class="form-group"><label>Week Ending</label><input type="date" name="weekDate" required></div>
           <div class="form-group"><label>Branch</label><input list="ls-branch" name="branch" required></div>
           <div id="cont-weekly">Loading...</div>
           <button class="btn">Submit</button>
        </form>
      </div>
      
      <!-- VACATION -->
      <div id="vacation" class="card">
        <h2>Vacation Request</h2>
        <form onsubmit="submitForm(event, 'Vacation')">
           <label>Dates</label>
           <div style="display:flex; gap:10px;"><input type="date" name="startDate" required><input type="date" name="endDate" required></div>
           <div class="form-group"><label>Reason</label><input name="reason" required></div>
           <button class="btn">Submit</button>
        </form>
      </div>

      <!-- TRAINING INDEX -->
      <div id="training-idx" class="card">
        <h2>Training Days</h2>
        <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(60px,1fr)); gap:10px;">
           <button class="btn" onclick="loadTraining(1)">1</button><button class="btn" onclick="loadTraining(2)">2</button>
           <button class="btn" onclick="loadTraining(3)">3</button><button class="btn" onclick="loadTraining(4)">4</button>
           <button class="btn" onclick="loadTraining(5)">5</button><button class="btn" onclick="loadTraining(6)">6</button>
           <button class="btn" onclick="loadTraining(7)">7</button><button class="btn" onclick="loadTraining(8)">8</button>
           <button class="btn" onclick="loadTraining(9)">9</button>
        </div>
        <div id="train-area" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;"></div>
      </div>

    </div>
  </div>

  <!-- DROPDOWNS -->
  <datalist id="ls-name"></datalist><datalist id="ls-branch"></datalist><datalist id="ls-sup"></datalist><datalist id="ls-am"></datalist>

  <script>
    const API = "YOUR_SCRIPT_DEPLOYMENT_URL_HERE"; // PASTE URL HERE
    
    let user = null;
    let isAdminMode = false;

    // --- INIT ---
    window.onload = () => {
       const session = localStorage.getItem('bonUser');
       if(session) {
          user = JSON.parse(session);
          initApp();
       } else {
          document.getElementById('global-loader').style.display = 'none';
       }
    };

    function toggleAdmin() {
       isAdminMode = !isAdminMode;
       document.getElementById('login-title').innerText = isAdminMode ? "Admin Login" : "Team Leader Portal";
    }

    async function tryLogin() {
       const u = document.getElementById('u').value;
       const p = document.getElementById('p').value;
       if(!u || !p) return alert("Fill all fields");

       setLoader(true, "Verifying...");
       const res = await fetchAPI('login', {username:u, password:p});
       if(res.success) {
          user = res;
          localStorage.setItem('bonUser', JSON.stringify(user));
          initApp();
       } else {
          setLoader(false);
          alert(res.message);
       }
    }

    async function initApp() {
       document.getElementById('login-view').style.display = 'none';
       setLoader(true, "Fetching Data...");
       
       // UI Setup
       document.getElementById('dash-name').innerText = user.name;
       document.getElementById('mini-name').innerText = user.name;
       document.getElementById('dash-id').innerText = "ID: " + user.id;
       document.getElementById('dash-img').src = user.image || "https://via.placeholder.com/80";
       document.getElementById('mini-av').src = user.image || "https://via.placeholder.com/30";
       
       if(user.role === 'Admin') document.querySelector('.admin-only').style.display = 'flex';

       // One-time Fetch
       const data = await fetchAPI('getStartupData');
       if(data) {
          fillList('ls-name', data.names);
          fillList('ls-branch', data.branches);
          fillList('ls-sup', data.sups);
          fillList('ls-am', data.ams);
          
          // Render Config Forms
          renderQs('cont-daily', data.dailyQs, 'daily');
          renderQs('cont-weekly', data.weeklyQs, 'weekly');
       }
       
       // Load Dashboard Stats
       await loadHistory();
       
       setLoader(false);
    }

    // --- NAVIGATION ---
    function nav(id) {
       document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
       document.getElementById(id).classList.add('active');
       document.getElementById('page-title').innerText = id.toUpperCase();
       if(window.innerWidth <= 768) {
          document.getElementById('sidebar').classList.remove('open');
          document.getElementById('main').classList.remove('full');
       }
    }
    function toggleMenu() {
       const sb = document.getElementById('sidebar');
       const mn = document.getElementById('main');
       if(window.innerWidth <= 768) { sb.classList.toggle('open'); }
       else { sb.classList.toggle('closed'); mn.classList.toggle('full'); }
    }
    function logout() { localStorage.removeItem('bonUser'); location.reload(); }

    // --- DASHBOARD LOGIC ---
    async function loadHistory() {
       const res = await fetchAPI('getTLHistory', {id: user.id});
       if(res) {
          document.getElementById('stat-d').innerText = res.stats.daily;
          document.getElementById('stat-w').innerText = res.stats.weekly;
          const rows = res.history.map(h => `<tr><td>${h.date}</td><td>${h.type}</td><td><span style="color:green;font-weight:bold;">${h.details}</span></td></tr>`).join('');
          document.getElementById('hist-body').innerHTML = rows || '<tr><td colspan="3">No records found</td></tr>';
       }
    }

    async function loadAdminData() {
       const s = document.getElementById('adm-start').value;
       const e = document.getElementById('adm-end').value;
       document.getElementById('adm-daily').innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
       
       const res = await fetchAPI('getDashboardData', {isAdmin:'true', start:s, end:e});
       if(res) {
          document.getElementById('adm-daily').innerHTML = res.daily.map(r => `<tr><td>${r.date}</td><td>${r.name}</td><td>${r.branch}</td><td>${r.status}</td></tr>`).join('');
       }
    }

    // --- FORMS ---
    function handleIssueType(el) {
       const val = el.value;
       document.getElementById('div-other').style.display = (val === 'Others') ? 'block' : 'none';
       const map = {"Maintenance":"High Priority","Team Member":"Low Priority","Customer Complaint":"Medium Priority"};
       document.getElementById('urgency').value = map[val] || "Review Required";
    }

    async function loadTraining(day) {
       document.getElementById('train-area').innerHTML = "Loading Day "+day+"...";
       const qs = await fetchAPI('getTrainingQuestions', {day: day});
       if(qs) {
          let h = `<form onsubmit="submitForm(event, 'Training Day ${day}')"><h3>Day ${day}</h3>`;
          h += `<div class="form-group"><label>Trainee Name</label><input name="traineeName" required></div>`;
          h += `<div class="form-group"><label>Trainee ID</label><input name="traineeId" required></div>`;
          h += `<div class="form-group"><label>Trainer Name</label><input list="ls-name" name="trainerName" required></div>`;
          qs.forEach((q,i) => h+= `<div style="margin:10px 0; border-bottom:1px solid #eee; padding-bottom:5px;">${q}<br><label style="display:inline"><input type="radio" name="q_${i}" value="Pass" required> Pass</label> <label style="display:inline"><input type="radio" name="q_${i}" value="Fail"> Fail</label></div>`);
          h += `<div class="form-group"><label>Notes</label><textarea name="notes"></textarea></div>`;
          h += `<button class="btn">Submit Training</button></form>`;
          document.getElementById('train-area').innerHTML = h;
       }
    }

    async function submitForm(e, cat) {
       e.preventDefault();
       const btn = e.target.querySelector('.btn');
       const txt = btn.innerText;
       btn.innerText = "Saving..."; btn.disabled = true;

       const fd = new FormData(e.target);
       const obj = { category: cat, name: user.name, empId: user.id };
       fd.forEach((v,k) => obj[k] = v);

       // Image Logic
       const fileInp = document.getElementById('f-file');
       if(cat === 'Report Problem' && fileInp && fileInp.files.length) {
           const reader = new FileReader();
           reader.readAsDataURL(fileInp.files[0]);
           reader.onload = async () => {
              obj.imageFile = reader.result;
              obj.imageName = fileInp.files[0].name;
              finishSubmit(obj, btn, txt, e.target);
           };
       } else {
           finishSubmit(obj, btn, txt, e.target);
       }
    }

    async function finishSubmit(obj, btn, txt, form) {
       const res = await fetch(API, {method:'POST', body:JSON.stringify(obj)}).then(r=>r.json());
       alert(res.message);
       btn.innerText = txt; btn.disabled = false;
       if(res.success) {
           form.reset();
           if(obj.category.includes('Training')) document.getElementById('train-area').innerHTML = '';
           if(!obj.category.includes('Admin')) loadHistory();
       }
    }

    // --- HELPERS ---
    function setLoader(show, text) {
       const l = document.getElementById('global-loader');
       l.style.display = show ? 'flex' : 'none';
       if(text) l.querySelector('p').innerText = text;
    }
    
    function fillList(id, arr) {
       document.getElementById(id).innerHTML = arr.map(v => `<option value="${v}">`).join('');
    }
    
    function renderQs(id, arr, prefix) {
       document.getElementById(id).innerHTML = arr.map((q,i) => 
          `<div style="margin-bottom:10px; background:#f9fafb; padding:10px; border-radius:6px;">${i+1}. ${q}<br>
           ${prefix==='daily' ? 
           `<label style="display:inline"><input type="radio" name="${prefix}_q_${i}" value="Yes"> Yes</label>
            <label style="display:inline"><input type="radio" name="${prefix}_q_${i}" value="No"> No</label>` 
            : `<input name="${prefix}_q_${i}" placeholder="Answer...">`}
           </div>`
       ).join('');
    }

    async function fetchAPI(act, p={}) {
       const u = new URL(API);
       u.searchParams.append('action', act);
       for(let k in p) u.searchParams.append(k, p[k]);
       try { return await fetch(u).then(r=>r.json()); } catch(e) { console.log(e); return null; }
    }
  </script>
</body>
</html>
